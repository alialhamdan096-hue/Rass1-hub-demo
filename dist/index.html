<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rass 1 Hub</title>
    <link rel="icon" href="logo.png" type="image/png">

    <script>
    // ÙØªØ­ Gmail Ù…Ø¨Ø§Ø´Ø±Ø© + ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ ÙƒÙˆØ¯ Ù‚Ø¯ÙŠÙ… ÙŠØªÙˆÙ‚Ø¹ window._currentEmail/openGmailPopup)
    (function() {
        var realOpen = window.open;

        window.open = function(url) {
            if (url && url.indexOf('mailto:') === 0) {
                var email = url.replace('mailto:', '').split('?')[0];
                var params = new URLSearchParams(url.split('?')[1] || '');
                var subject = decodeURIComponent(params.get('subject') || '');
                var body = decodeURIComponent(params.get('body') || '');

                // âœ… Ù„Ù„ØªÙˆØ§ÙÙ‚: Ù†Ø®Ø²Ù†Ù‡Ø§ (Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø§ Ø¹Ù†Ø¯Ù†Ø§ Ù…ÙˆØ¯Ø§Ù„)
                window._currentEmail = { to: email, subject: subject, body: body };

                // ÙØªØ­ Gmail Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ popup
                var gmailUrl = 'https://mail.google.com/mail/?view=cm&fs=1' +
                    '&to=' + encodeURIComponent(email) +
                    '&su=' + encodeURIComponent(subject) +
                    '&body=' + encodeURIComponent(body);

                var width = 600, height = 600;
                var left = (screen.width - width) / 2;
                var top = (screen.height - height) / 2;

                realOpen(gmailUrl, 'gmailCompose',
                    'width=' + width + ',height=' + height + ',left=' + left + ',top=' + top + ',popup=yes,scrollbars=yes');

                return null;
            }
            return realOpen.apply(this, arguments);
        };

        window._realOpen = realOpen;

        // âœ… ØªØ¹Ø±ÙŠÙ Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ù„Ùˆ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠÙ†Ø§Ø¯ÙŠ openGmailPopup()
        window.openGmailPopup = function() {
            var email = window._currentEmail;
            if (!email) return;

            var gmailUrl = 'https://mail.google.com/mail/?view=cm&fs=1' +
                '&to=' + encodeURIComponent(email.to) +
                '&su=' + encodeURIComponent(email.subject || '') +
                '&body=' + encodeURIComponent(email.body || '');

            var width = 600, height = 600;
            var left = (screen.width - width) / 2;
            var top = (screen.height - height) / 2;

            realOpen(gmailUrl, 'gmailCompose',
                'width=' + width + ',height=' + height + ',left=' + left + ',top=' + top + ',popup=yes,scrollbars=yes');
        };
    })();
    </script>

    <script type="module" crossorigin src="/assets/index-BPUQy5C5.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-BLJBIK8U.css">
</head>

<body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-icon" id="modalIcon">âš ï¸</div>
            <div class="modal-title" id="modalTitle">Confirm</div>
            <div class="modal-message" id="modalMessage">Are you sure?</div>
            <div class="modal-actions">
                <button class="modal-cancel" id="modalCancelBtn">Cancel</button>
                <button class="modal-confirm" id="modalConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="historyModal">
        <div class="modal history-modal">
            <div class="history-header">
                <div class="history-title">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶</div>
                <button class="history-close" id="historyCloseBtn">Ã—</button>
            </div>
            <div class="history-patient-info">
                <div class="history-patient-name" id="historyPatientName"></div>
                <div class="history-patient-phone" id="historyPatientPhone"></div>
                <div class="history-patient-med" id="historyPatientMed"></div>
            </div>
            <div class="history-content" id="historyContent"></div>
        </div>
    </div>

    <div class="modal-overlay" id="labelModal">
        <div class="modal label-modal">
            <div class="label-header">
                <div class="label-title">ğŸ·ï¸ Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„ØµÙ‚</div>
                <button class="label-close" id="labelCloseBtn">Ã—</button>
            </div>
            <div class="label-preview" id="labelPreview"></div>
            <div class="label-actions">
                <button class="btn btn-secondary" id="labelCancelBtn">Ø¥ØºÙ„Ø§Ù‚</button>
                <button class="btn btn-primary" id="labelPrintBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
            </div>
        </div>
    </div>

    <!-- âœ… Email placeholders (Ù…Ø®ÙÙŠØ©) Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù„Ùˆ Ù…Ù„Ù JS ÙŠØªÙˆÙ‚Ø¹Ù‡Ø§ -->
    <div id="emailModal" style="display:none;">
        <div id="emailTo"></div>
        <div id="emailSubject"></div>
        <div id="emailBody"></div>
    </div>

    <!-- Scanner Sheets Modal - ØªØ®Ø²ÙŠÙ† Ø³Ø­Ø§Ø¨ÙŠ -->
    <div id="sheetsModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(3px);">
        <div style="background:white;border-radius:16px;padding:20px;max-width:550px;width:90%;text-align:right;direction:rtl;box-shadow:0 15px 50px rgba(0,0,0,0.3);">
            <style>
                .sheets-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #e9ecef;}
                .sheets-title{font-size:18px;font-weight:bold;color:#34a853;}
                .sheets-close{background:#f1f3f4;border:none;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer;color:#5f6368;}
                .sheets-close:hover{background:#e8eaed;}
                .sheets-config{background:#f8f9fa;border-radius:10px;padding:12px;margin-bottom:15px;border:1px solid #e9ecef;}
                .sheets-config-label{font-size:12px;color:#666;margin-bottom:6px;display:flex;align-items:center;gap:5px;}
                .sheets-config-input{width:100%;padding:10px 12px;border:2px solid #e9ecef;border-radius:8px;font-size:13px;direction:ltr;font-family:monospace;}
                .sheets-config-input:focus{border-color:#34a853;outline:none;}
                .sheets-config-status{font-size:11px;margin-top:6px;padding:4px 8px;border-radius:4px;display:inline-block;}
                .sheets-config-status.connected{background:#d4edda;color:#155724;}
                .sheets-config-status.disconnected{background:#f8d7da;color:#721c24;}
                .sheets-config-status.loading{background:#fff3cd;color:#856404;}
                .sheets-divider{border:none;border-top:1px dashed #dee2e6;margin:15px 0;}
                .sheets-input-group{display:flex;gap:8px;margin-bottom:12px;}
                .sheets-input{flex:1;padding:10px 12px;border:2px solid #e9ecef;border-radius:8px;font-size:14px;direction:ltr;}
                .sheets-input:focus{border-color:#34a853;outline:none;}
                .sheets-add-btn{padding:10px 16px;background:#34a853;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s;}
                .sheets-add-btn:hover{background:#2d8e47;}
                .sheets-add-btn:disabled{background:#ccc;cursor:not-allowed;}
                .sheets-list{max-height:200px;overflow-y:auto;margin-bottom:15px;}
                .sheets-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#f8f9fa;border-radius:8px;margin-bottom:8px;direction:ltr;transition:all 0.2s;}
                .sheets-item:hover{background:#e9ecef;}
                .sheets-item-name{font-size:13px;color:#333;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-left:10px;}
                .sheets-item-del{background:#dc3545;color:white;border:none;width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:14px;transition:all 0.2s;}
                .sheets-item-del:hover{background:#c82333;}
                .sheets-empty{text-align:center;padding:30px;color:#999;}
                .sheets-actions{display:flex;gap:10px;}
                .sheets-save-btn{flex:1;padding:12px;background:linear-gradient(135deg,#34a853 0%,#2d8e47 100%);color:white;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s;}
                .sheets-save-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(52,168,83,0.3);}
                .sheets-save-btn:disabled{background:#ccc;cursor:not-allowed;transform:none;box-shadow:none;}
                .sheets-refresh-btn{padding:12px 16px;background:#4285f4;color:white;border:none;border-radius:10px;font-size:15px;cursor:pointer;transition:all 0.2s;}
                .sheets-refresh-btn:hover{background:#3367d6;}
                .sheets-refresh-btn:disabled{background:#ccc;cursor:not-allowed;}
                .sheets-help{font-size:11px;color:#888;margin-top:10px;padding:10px;background:#f8f9fa;border-radius:8px;line-height:1.6;}
                .sheets-help a{color:#4285f4;text-decoration:none;}
            </style>
            <div class="sheets-header">
                <span class="sheets-title">ğŸ“Š Ø±ÙˆØ§Ø¨Ø· Google Sheets Ù„Ù„Ø³ÙƒØ§Ù†Ø±</span>
                <button class="sheets-close" onclick="closeSheetsModal()">Ã—</button>
            </div>
            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø´ÙŠØª Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ -->
            <div class="sheets-config">
                <div class="sheets-config-label">
                    âš™ï¸ Ø±Ø§Ø¨Ø· Web App (Ø´ÙŠØª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
                    <span class="sheets-config-status" id="configStatus">ØºÙŠØ± Ù…ØªØµÙ„</span>
                </div>
                <input type="text" class="sheets-config-input" id="configSheetUrl" placeholder="https://script.google.com/macros/s/.../exec" onchange="saveConfigUrl()">
                <div class="sheets-help">
                    ğŸ’¡ Ø£Ù†Ø´Ø¦ Ø´ÙŠØª Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù†Ø´Ø±Ù‡ ÙƒÙ€ Web App Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù…. <a href="#" onclick="showSetupInstructions(); return false;">Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</a>
                </div>
            </div>
            <hr class="sheets-divider">
            <!-- Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø´ÙŠØªØ§Øª -->
            <div class="sheets-input-group">
                <input type="text" class="sheets-input" id="newSheetUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
                <button class="sheets-add-btn" id="addSheetBtn" onclick="addSheetUrl()">â• Ø£Ø¶Ù</button>
            </div>
            <div class="sheets-list" id="sheetsList">
                <div class="sheets-empty">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
            <div class="sheets-actions">
                <button class="sheets-refresh-btn" id="refreshBtn" onclick="loadSheetsFromCloud()">ğŸ”„</button>
                <button class="sheets-save-btn" id="saveBtn" onclick="saveSheetsToCloud()">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
            </div>
        </div>
    </div>

    <!-- Setup Instructions Modal -->
    <div id="setupModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:100000;backdrop-filter:blur(3px);">
        <div style="background:white;border-radius:16px;padding:25px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;text-align:right;direction:rtl;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="margin:0;color:#34a853;">ğŸ“– ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯</h3>
                <button onclick="document.getElementById('setupModal').style.display='none'" style="background:#f1f3f4;border:none;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer;">Ã—</button>
            </div>
            <div style="line-height:1.8;font-size:14px;">
                <h4 style="color:#4285f4;margin:15px 0 10px;">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ù†Ø´Ø§Ø¡ Ø´ÙŠØª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h4>
                <ol style="padding-right:20px;">
                    <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ <a href="https://sheets.google.com" target="_blank" style="color:#4285f4;">Google Sheets</a> ÙˆØ£Ù†Ø´Ø¦ Ø´ÙŠØª Ø¬Ø¯ÙŠØ¯</li>
                    <li>Ø³Ù…Ù‘Ù‡ Ù…Ø«Ù„Ø§Ù‹: <code style="background:#f4f4f4;padding:2px 6px;border-radius:4px;">Rass1 Config</code></li>
                    <li>ØºÙŠÙ‘Ø± Ø§Ø³Ù… Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¥Ù„Ù‰: <code style="background:#f4f4f4;padding:2px 6px;border-radius:4px;">ScannerSheets</code></li>
                </ol>
                <h4 style="color:#4285f4;margin:15px 0 10px;">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¶Ø§ÙØ© Apps Script</h4>
                <ol style="padding-right:20px;">
                    <li>Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: <strong>Extensions â†’ Apps Script</strong></li>
                    <li>Ø§Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ:</li>
                </ol>
                <pre style="background:#1e1e1e;color:#d4d4d4;padding:15px;border-radius:8px;font-size:11px;overflow-x:auto;direction:ltr;text-align:left;"><code>function doGet(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("ScannerSheets");
  var data = sheet.getRange("A:A").getValues();
  var urls = [];
  for (var i = 0; i < data.length; i++) {
    if (data[i][0] !== '') urls.push(data[i][0]);
  }
  return ContentService.createTextOutput(JSON.stringify(urls))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("ScannerSheets");
  var data = JSON.parse(e.postData.contents);
  sheet.getRange("A:A").clearContent();
  if (data.urls && data.urls.length > 0) {
    var range = sheet.getRange(1, 1, data.urls.length, 1);
    var values = [];
    for (var i = 0; i < data.urls.length; i++) {
      values.push([data.urls[i]]);
    }
    range.setValues(values);
  }
  return ContentService.createTextOutput(JSON.stringify({success: true}))
    .setMimeType(ContentService.MimeType.JSON);
}</code></pre>
                <h4 style="color:#4285f4;margin:15px 0 10px;">Ø§Ù„Ø®Ø·ÙˆØ© 3: Ù†Ø´Ø± ÙƒÙ€ Web App</h4>
                <ol style="padding-right:20px;">
                    <li>Ø§Ø¶ØºØ· <strong>Deploy â†’ New deployment</strong></li>
                    <li>Ø§Ø®ØªØ± <strong>Web app</strong></li>
                    <li>Execute as: <strong>Me</strong></li>
                    <li>Who has access: <strong>Anyone</strong></li>
                    <li>Ø§Ø¶ØºØ· <strong>Deploy</strong></li>
                    <li>Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ https://script.google.com/macros/s/...)</li>
                    <li>Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ Ø®Ø§Ù†Ø© "Ø±Ø§Ø¨Ø· Web App" Ø£Ø¹Ù„Ø§Ù‡</li>
                </ol>
                <div style="background:#d4edda;padding:12px;border-radius:8px;margin-top:15px;">
                    âœ… <strong>ØªÙ…!</strong> Ø§Ù„Ø¢Ù† Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø´ÙŠØªØ§Øª Ø³ØªÙØ­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØªØ¨Ù‚Ù‰ Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø£ÙŠ ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…ÙˆÙ‚Ø¹.
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // ğŸ”§ Ø¥Ø¯Ø§Ø±Ø© Ø±ÙˆØ§Ø¨Ø· Google Sheets - ØªØ®Ø²ÙŠÙ† Ø³Ø­Ø§Ø¨ÙŠ
        // =====================================================
        var scannerSheets = [];
        var configUrl = localStorage.getItem('configSheetUrl') || '';
        var isLoading = false;

        // ØªØ­Ù…ÙŠÙ„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Config Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        document.addEventListener('DOMContentLoaded', function() {
            var configInput = document.getElementById('configSheetUrl');
            if (configInput && configUrl) {
                configInput.value = configUrl;
                loadSheetsFromCloud();
            } else {
                updateConfigStatus('disconnected', 'ØºÙŠØ± Ù…ØªØµÙ„');
                // ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage ÙƒÙ€ fallback
                scannerSheets = JSON.parse(localStorage.getItem('scannerSheets') || '[]');
                renderSheetsList();
            }
        });

        function saveConfigUrl() {
            var input = document.getElementById('configSheetUrl');
            configUrl = input.value.trim();
            localStorage.setItem('configSheetUrl', configUrl);
            if (configUrl) {
                loadSheetsFromCloud();
            } else {
                updateConfigStatus('disconnected', 'ØºÙŠØ± Ù…ØªØµÙ„');
            }
        }

        function updateConfigStatus(status, text) {
            var el = document.getElementById('configStatus');
            if (el) {
                el.className = 'sheets-config-status ' + status;
                el.textContent = text;
            }
        }

        function loadSheetsFromCloud() {
            if (!configUrl) {
                updateConfigStatus('disconnected', 'ØºÙŠØ± Ù…ØªØµÙ„');
                scannerSheets = JSON.parse(localStorage.getItem('scannerSheets') || '[]');
                renderSheetsList();
                return;
            }
            isLoading = true;
            updateConfigStatus('loading', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
            setButtonsState(true);
            fetch(configUrl)
                .then(function(response) {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(function(data) {
                    scannerSheets = Array.isArray(data) ? data : [];
                    localStorage.setItem('scannerSheets', JSON.stringify(scannerSheets));
                    updateConfigStatus('connected', 'âœ… Ù…ØªØµÙ„ (' + scannerSheets.length + ' Ø±ÙˆØ§Ø¨Ø·)');
                    renderSheetsList();
                })
                .catch(function(error) {
                    console.error('Load error:', error);
                    scannerSheets = JSON.parse(localStorage.getItem('scannerSheets') || '[]');
                    updateConfigStatus('disconnected', 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                    renderSheetsList();
                })
                .finally(function() {
                    isLoading = false;
                    setButtonsState(false);
                });
        }

        function saveSheetsToCloud() {
            if (!configUrl) {
                alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Web App Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            isLoading = true;
            updateConfigStatus('loading', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
            setButtonsState(true);
            fetch(configUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ urls: scannerSheets })
            })
                .then(function() {
                    localStorage.setItem('scannerSheets', JSON.stringify(scannerSheets));
                    updateConfigStatus('connected', 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ (' + scannerSheets.length + ' Ø±ÙˆØ§Ø¨Ø·)');
                    showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 'success');
                })
                .catch(function(error) {
                    console.error('Save error:', error);
                    localStorage.setItem('scannerSheets', JSON.stringify(scannerSheets));
                    updateConfigStatus('disconnected', 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸');
                    showToast('âš ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·', 'warning');
                })
                .finally(function() {
                    isLoading = false;
                    setButtonsState(false);
                });
        }

        function setButtonsState(disabled) {
            var btns = ['addSheetBtn', 'saveBtn', 'refreshBtn'];
            btns.forEach(function(id) {
                var btn = document.getElementById(id);
                if (btn) btn.disabled = disabled;
            });
        }

        function openSheetsModal() {
            document.getElementById('sheetsModal').style.display = 'flex';
            if (configUrl) {
                loadSheetsFromCloud();
            } else {
                renderSheetsList();
            }
        }

        function closeSheetsModal() {
            document.getElementById('sheetsModal').style.display = 'none';
        }

        function renderSheetsList() {
            var list = document.getElementById('sheetsList');
            if (!list) return;
            if (scannerSheets.length === 0) {
                list.innerHTML = '<div class="sheets-empty">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ù…Ø¶Ø§ÙØ©</div>';
                return;
            }
            list.innerHTML = scannerSheets.map(function(url, i) {
                var shortUrl = url.length > 45 ? url.substring(0, 45) + '...' : url;
                return '<div class="sheets-item"><span class="sheets-item-name" title="' + url + '">' + shortUrl + '</span><button class="sheets-item-del" onclick="removeSheet(' + i + ')" title="Ø­Ø°Ù">ğŸ—‘ï¸</button></div>';
            }).join('');
        }

        function addSheetUrl() {
            var input = document.getElementById('newSheetUrl');
            var url = input.value.trim();
            if (!url) return;
            if (!url.includes('docs.google.com/spreadsheets')) {
                alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Google Sheets ØµØ­ÙŠØ­');
                return;
            }
            if (scannerSheets.includes(url)) {
                alert('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                return;
            }
            scannerSheets.push(url);
            input.value = '';
            renderSheetsList();
            localStorage.setItem('scannerSheets', JSON.stringify(scannerSheets));
            showToast('â• ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© - Ø§Ø¶ØºØ· "Ø­ÙØ¸" Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'info');
        }

        function removeSheet(index) {
            scannerSheets.splice(index, 1);
            renderSheetsList();
            localStorage.setItem('scannerSheets', JSON.stringify(scannerSheets));
            showToast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù - Ø§Ø¶ØºØ· "Ø­ÙØ¸" Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'info');
        }

        function showSetupInstructions() {
            document.getElementById('setupModal').style.display = 'flex';
        }

        function showToast(message, type) {
            var container = document.getElementById('toastContainer');
            if (!container) return;
            var toast = document.createElement('div');
            toast.className = 'toast toast-' + (type || 'info');
            toast.textContent = message;
            toast.style.cssText = 'background:#333;color:white;padding:12px 20px;border-radius:8px;margin-bottom:10px;animation:slideIn 0.3s ease;';
            if (type === 'success') toast.style.background = '#28a745';
            if (type === 'warning') toast.style.background = '#ffc107; color: #333;';
            if (type === 'error') toast.style.background = '#dc3545';
            container.appendChild(toast);
            setTimeout(function() {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(function() {
                    if (toast.parentNode) toast.parentNode.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // âœ… Ø¬Ø¹Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…ØªØ§Ø­Ø© Ù„Ù„Ø³ÙƒØ§Ù†Ø±
        window.getScannerSheets = function() {
            return scannerSheets.length > 0 ? scannerSheets : JSON.parse(localStorage.getItem('scannerSheets') || '[]');
        };
    </script>

    <div class="container">
        <div class="header-container">
            <img src="logo.png" alt="Rass 1" class="logo-img" onerror="this.style.display='none'">
            <h1>Rass 1 Hub</h1>
            <button onclick="openSheetsModal()" style="position:absolute;left:15px;top:50%;transform:translateY(-50%);background:linear-gradient(135deg,#34a853 0%,#2d8e47 100%);color:white;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;box-shadow:0 2px 8px rgba(52,168,83,0.3);">ğŸ“Š Sheets</button>
        </div>

        <div class="tabs">
            <button class="tab active" data-page="patients">ğŸ’Š Records</button>
            <button class="tab" data-page="orders">ğŸ“¦ Transfer Requests</button>
            <button class="tab" data-page="tracking">ğŸ“Š Tracking</button>
            <button class="tab" data-page="reports">ğŸ“ˆ Reports</button>
        </div>

        <div id="sync" class="sync sync-ok">âœ“ Connected to Google Sheets</div>
        <div class="alert-banner hidden" id="alertBanner">
            <span class="alert-banner-icon">ğŸ””</span>
            <span class="alert-banner-text" id="alertText"></span>
            <button class="alert-banner-close" onclick="document.getElementById('alertBanner').classList.add('hidden')">Ã—</button>
        </div>

        <!-- Patients Page -->
        <div id="patientsPage" class="page active">
            <div class="stats">
                <div class="stat total"><div class="stat-num" id="total">0</div><div class="stat-label">Records</div></div>
                <div class="stat w"><div class="stat-num" id="warn">0</div><div class="stat-label">Soon</div></div>
                <div class="stat d"><div class="stat-num" id="over">0</div><div class="stat-label">Overdue</div></div>
                <div class="stat orders"><div class="stat-num" id="pendingOrders">0</div><div class="stat-label">ğŸ“¦ Pending</div></div>
            </div>
            <div class="grid">
                <div class="card">
                    <h3 class="card-title" id="formTitle">â• Add New</h3>
                    <div class="type-selector">
                        <button type="button" class="type-btn active refill" data-type="refill">
                            <div class="type-btn-icon">ğŸ’Š</div><div class="type-btn-label">Refill</div>
                        </button>
                        <button type="button" class="type-btn order" data-type="order">
                            <div class="type-btn-icon">ğŸ“¦</div><div class="type-btn-label">Order</div>
                        </button>
                    </div>
                    <form id="patientForm" novalidate>
                        <input type="hidden" id="entryType" value="refill">
                        <div class="form-group"><label>Customer Name (Optional)</label><input type="text" id="name" placeholder="Enter name"></div>
                        <div class="form-group"><label>Phone <span class="required">*</span></label><input type="tel" id="phone" placeholder="966512345678"><div class="error-message" id="phoneError">Please enter a valid phone</div></div>
                        <div class="form-group"><label id="medLabel">Medication <span class="required">*</span></label><input type="text" id="med" placeholder="Medication name"><div class="error-message" id="medError">Please enter medication</div></div>
                        <div id="refillFields">
                            <div class="row">
                                <div class="form-group"><label>Dispense Date <span class="required">*</span></label><input type="date" id="date"><div class="error-message" id="dateError">Please select date</div></div>
                                <div class="form-group"><label>Duration (days) <span class="required">*</span></label><input type="number" id="days" value="30" min="1" max="365"><div class="error-message" id="daysError">Enter 1-365</div></div>
                            </div>
                        </div>
                        <div id="orderFields" style="display:none">
                            <div class="form-group">
                                <label>From Branch <span class="required">*</span></label>
                                <select id="branch">
                                    <option value="">Select branch...</option>
                                    <option>RASS2</option><option>RASS5</option><option>UNIZAH1</option><option>UNIZAH2</option><option>UNIZAH3</option><option>UNIZAH4</option><option>UNIZAH5</option>
                                    <option>BADAYA1</option><option>BADAYA2</option><option>BADAYA3</option><option>BADAYA5</option><option>BADAYA.MOR</option>
                                    <option>BUKAYRIAH1</option><option>BUKAYRIAH2</option><option>BUKAYRIAH.MOR</option>
                                    <option>BURIDAH1</option><option>BURIDAH2</option>
                                    <option>KHABRA1</option><option>MITHNAB1</option><option>MITHNAB2</option><option>RIYADH.KHABRA.MOR</option>
                                </select>
                                <div class="error-message" id="branchError">Please select branch</div>
                            </div>
                            <div class="form-group">
                                <label>Pickup Date (Optional)</label>
                                <select id="pickupDate">
                                    <option value="">Not specified</option><option value="today">Today</option><option value="tomorrow">Tomorrow</option><option value="custom">Custom...</option>
                                </select>
                            </div>
                            <div class="form-group" id="customDateGroup" style="display:none"><label>Custom Date</label><input type="date" id="customPickupDate"></div>
                        </div>
                        <div class="form-group"><label>Notes</label><input type="text" id="notes" placeholder="Additional notes"></div>
                        <button type="submit" class="btn btn-primary" id="submitBtn"><span>â•</span> Add</button>
                        <button type="button" class="btn btn-secondary" id="cancelBtn" onclick="window.resetForm()">Cancel</button>
                    </form>
                </div>

                <div class="card">
                    <h3 class="card-title">ğŸ“‹ Records</h3>
                    <div class="filters-row">
                        <input type="text" id="search" placeholder="ğŸ” Search...">
                        <select id="typeFilter"><option value="all">All Types</option><option value="refill">ğŸ’Š Refill</option><option value="order">ğŸ“¦ Orders</option></select>
                        <select id="statusFilter"><option value="all">All Status</option><option value="overdue">ğŸ”´ Overdue</option><option value="soon">ğŸŸ¡ Soon</option><option value="ok">ğŸŸ¢ OK</option><option value="waiting">ğŸ”µ Waiting</option><option value="pending">â³ Pending</option></select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Type</th><th>Customer</th><th>Item / Med</th><th>Added</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="patientsTbody"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="pagination"></div>
                </div>
            </div>
        </div>

        <!-- Orders Page -->
        <div id="ordersPage" class="page">
            <div class="grid">
                <div class="card">
                    <h3 class="card-title">â• Add Item</h3>
                    <form id="orderForm" novalidate>
                        <div class="form-group"><label>Item Name <span class="required">*</span></label><input type="text" id="orderMed" placeholder="Product name"><div class="error-message" id="orderMedError">Please enter item name</div></div>
                        <div class="row">
                            <div class="form-group"><label>Quantity <span class="required">*</span></label><input type="number" id="orderQty" value="1" min="1"></div>
                            <div class="form-group">
                                <label>From Branch <span class="required">*</span></label>
                                <select id="orderBranch">
                                    <option value="">Select...</option>
                                    <option value="RASS2">RASS2</option><option value="RASS5">RASS5</option><option value="UNIZAH1">UNIZAH1</option><option value="UNIZAH2">UNIZAH2</option><option value="UNIZAH3">UNIZAH3</option><option value="UNIZAH4">UNIZAH4</option><option value="UNIZAH5">UNIZAH5</option>
                                    <option value="BADAYA1">BADAYA1</option><option value="BADAYA2">BADAYA2</option><option value="BADAYA3">BADAYA3</option><option value="BADAYA5">BADAYA5</option><option value="BADAYA.MOR">BADAYA.MOR</option>
                                    <option value="BUKAYRIAH1">BUKAYRIAH1</option><option value="BUKAYRIAH2">BUKAYRIAH2</option><option value="BUKAYRIAH.MOR">BUKAYRIAH.MOR</option>
                                    <option value="BURIDAH1">BURIDAH1</option><option value="BURIDAH2">BURIDAH2</option><option value="KHABRA1">KHABRA1</option><option value="MITHNAB1">MITHNAB1</option><option value="MITHNAB2">MITHNAB2</option><option value="RIYADH.KHABRA.MOR">RIYADH.KHABRA.MOR</option>
                                </select>
                                <div class="error-message" id="orderBranchError">Please select branch</div>
                            </div>
                        </div>
                        <div class="checkbox-wrapper"><input type="checkbox" id="orderClient"><label for="orderClient">ğŸ”´ Ù„Ø¹Ù…ÙŠÙ„ (For Client)</label></div>
                        <button type="submit" class="btn btn-primary">â• Add to List</button>
                    </form>
                </div>

                <div class="card">
                    <h3 class="card-title">ğŸ“‹ Transfer List</h3>
                    <div id="ordersList"></div>
                    <button class="btn btn-danger btn-sm" id="clearAllBtn" style="margin-top:10px;display:none;">ğŸ—‘ï¸ Clear All</button>

                    <div class="send-section" id="sendSection" style="display:none">
                        <h3 class="card-title">ğŸ“§ Ready to Send</h3>
                        <div id="groupedOrders"></div>

                        <!-- âœ… Ø±Ø¬Ø¹Ù†Ø§Ù‡ Ù„Ù„ØªÙˆØ§ÙÙ‚ (Ù…Ø®ÙÙŠ) Ø­ØªÙ‰ Ù„Ø§ ÙŠØ·ÙŠÙ‘Ø­ addEventListener -->
                        <button class="btn btn-success" id="sendAllBtn" style="margin-top:10px; display:none;">
                            ğŸ“§ Send All Emails
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tracking Page -->
        <div id="trackingPage" class="page">
            <div class="stats">
                <div class="stat total"><div class="stat-num" id="tSent">0</div><div class="stat-label">Sent</div></div>
                <div class="stat s"><div class="stat-num" id="tConverted">0</div><div class="stat-label">Converted</div></div>
                <div class="stat" style="border-left:4px solid var(--primary)"><div class="stat-num" id="tRate">0%</div><div class="stat-label">Rate</div></div>
            </div>
            <div class="card">
                <div class="header-row">
                    <h3 class="card-title" style="margin:0">ğŸ“Š Track Conversions</h3>
                    <select id="trackFilter" style="width:auto;min-width:140px"><option value="all">All</option><option value="waiting">â³ Waiting</option><option value="converted">âœ… Converted</option></select>
                </div>
                <div class="track-grid" id="trackGrid"></div>
            </div>
        </div>

        <!-- Reports Page -->
        <div id="reportsPage" class="page">
            <div class="card">
                <div class="header-row">
                    <h3 class="card-title" style="margin:0">ğŸ“ˆ Monthly Report</h3>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <select id="reportMonth" style="width:auto"></select>
                        <select id="reportYear" style="width:auto"></select>
                        <button class="btn btn-secondary btn-sm" onclick="window.print()">ğŸ–¨ï¸</button>
                    </div>
                </div>
                <div class="report-tabs">
                    <button class="report-tab active" data-report="refill">ğŸ’Š Refill</button>
                    <button class="report-tab" data-report="orders">ğŸ“¦ Transfers</button>
                </div>
            </div>

            <div id="refillReport" class="report-section active">
                <div class="report-grid">
                    <div class="report-card"><div class="report-value" id="rSent">0</div><div class="report-label">ğŸ“¤ Sent</div></div>
                    <div class="report-card"><div class="report-value" style="color:var(--accent)" id="rConverted">0</div><div class="report-label">âœ… Converted</div></div>
                    <div class="report-card"><div class="report-value" style="color:var(--primary)" id="rRate">0%</div><div class="report-label">ğŸ“Š Rate</div><div class="progress"><div class="progress-bar" id="rBar" style="width:0%;background:var(--accent)"></div></div></div>
                </div>

                <div class="card">
                    <h3 class="card-title">ğŸ“‹ Summary</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Metric</th><th>Count</th><th>%</th></tr></thead>
                            <tbody id="summaryTb"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">âœ… Converted Patients</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Patient</th><th>Phone</th><th>Medication</th><th>Reminder</th><th>Converted</th></tr></thead>
                            <tbody id="convList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="ordersReport" class="report-section">
                <div class="report-grid">
                    <div class="report-card"><div class="report-value" style="color:var(--info)" id="oTotal">0</div><div class="report-label">ğŸ“¦ Total</div></div>
                    <div class="report-card"><div class="report-value" style="color:var(--accent)" id="oDelivered">0</div><div class="report-label">âœ… Delivered</div></div>
                    <div class="report-card"><div class="report-value" style="color:var(--warning)" id="oNotDelivered">0</div><div class="report-label">â³ Pending</div></div>
                    <div class="report-card"><div class="report-value" style="color:var(--primary)" id="oRate">0%</div><div class="report-label">ğŸ“Š Rate</div><div class="progress"><div class="progress-bar" id="oBar" style="width:0%;background:var(--info)"></div></div></div>
                </div>

                <div class="card">
                    <h3 class="card-title">ğŸ¢ By Branch</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Branch</th><th>Total</th><th>Delivered</th><th>Pending</th></tr></thead>
                            <tbody id="branchSummary"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">ğŸ“¦ Top Items</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Item Name</th><th>Count</th></tr></thead>
                            <tbody id="topMeds"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rass 1 Hub - Scanner</title>

    <link rel="icon" href="logo.png" type="image/png">

    <style>
        :root {
            --primary:#561C2C;
            --primary-light:#7a2840;
            --accent:#8DC63F;
            --accent-dark:#6fa329;
            --danger:#e74c3c;
            --gray:#666;
        }

        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            min-height:100vh;
            background:radial-gradient(circle at top,#1f2937 0%,#020617 55%,#000 100%);
            color:#e5e7eb;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:20px;
        }

        .wrapper{
            max-width:420px;
            width:100%;
        }

        .logo{
            text-align:center;
            margin-bottom:12px;
        }
        .logo img{
            height:70px;
            filter:drop-shadow(0 2px 6px rgba(0,0,0,0.4));
        }
        .title{
            text-align:center;
            margin-bottom:18px;
        }
        .title h1{
            font-size:20px;
            color:#f9fafb;
            margin-bottom:4px;
        }
        .title p{
            font-size:13px;
            color:#9ca3af;
        }

        .card{
            background:rgba(15,23,42,0.9);
            border-radius:16px;
            padding:18px 18px 20px;
            box-shadow:0 18px 45px rgba(0,0,0,0.6);
            border:1px solid rgba(148,163,184,0.25);
        }

        .main-actions{
            display:flex;
            flex-direction:column;
            gap:10px;
            margin-bottom:10px;
        }

        .btn{
            width:100%;
            border:none;
            border-radius:999px;
            padding:12px 18px;
            font-weight:600;
            font-size:14px;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            transition:.25s;
        }
        .btn-primary{
            background:linear-gradient(135deg,var(--primary),var(--primary-light));
            color:#fff;
        }
        .btn-primary:hover{
            transform:translateY(-1px);
            box-shadow:0 6px 18px rgba(86,28,44,0.6);
        }
        .btn-outline{
            background:transparent;
            color:#e5e7eb;
            border:1px solid rgba(148,163,184,0.5);
        }
        .btn-outline:hover{
            background:rgba(15,23,42,0.8);
        }

        .hint{
            text-align:center;
            font-size:11px;
            color:#9ca3af;
            margin-top:4px;
        }

        /* ======= Scanner Modals / Layout ======= */
        .scanner-modal{
            position:fixed;
            inset:0;
            background:rgba(15,23,42,0.9);
            backdrop-filter:blur(6px);
            display:flex;
            align-items:center;
            justify-content:center;
            opacity:0;
            visibility:hidden;
            transition:.25s;
            z-index:9999;
        }
        .scanner-modal.active{
            opacity:1;
            visibility:visible;
        }
        .scanner-modal-content{
            width:100%;
            max-width:480px;
            background:radial-gradient(circle at top,#111827 0%,#020617 55%,#000 100%);
            border-radius:18px;
            padding:16px 16px 18px;
            border:1px solid rgba(148,163,184,0.4);
            box-shadow:0 22px 60px rgba(0,0,0,0.8);
            position:relative;
            color:#e5e7eb;
        }
        .scanner-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            margin-bottom:10px;
        }
        .scanner-header h2{
            font-size:16px;
        }
        .scanner-close-btn{
            border:none;
            background:transparent;
            color:#9ca3af;
            font-size:22px;
            cursor:pointer;
            line-height:1;
        }
        .scanner-close-btn:hover{
            color:#e5e7eb;
        }

        .scanner-preview{
            width:100%;
            aspect-ratio:3/2;
            border-radius:16px;
            overflow:hidden;
            background:#000;
            position:relative;
        }
        .scanner-preview::after{
            content:'';
            position:absolute;
            inset:16px;
            border-radius:14px;
            border:2px dashed rgba(248,250,252,0.4);
            box-shadow:0 0 0 999px rgba(0,0,0,0.3);
            pointer-events:none;
        }

        .scanner-hint{
            font-size:12px;
            color:#9ca3af;
            margin-top:8px;
            text-align:center;
        }

        .manual-search-section{
            margin-top:14px;
        }
        .manual-search-divider{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            color:#9ca3af;
            font-size:11px;
            margin-bottom:8px;
        }
        .manual-search-divider::before,
        .manual-search-divider::after{
            content:'';
            flex:1;
            height:1px;
            background:linear-gradient(to left,transparent,rgba(148,163,184,0.7));
        }
        .manual-search-divider::after{
            background:linear-gradient(to right,transparent,rgba(148,163,184,0.7));
        }

        .manual-search-input{
            display:flex;
            gap:8px;
        }

        .manual-search-input input{
            flex:1;
            padding:10px 12px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.4);
            background:rgba(15,23,42,0.9);
            color:#e5e7eb;
            font-size:13px;
        }
        .manual-search-input input:focus{
            outline:none;
            border-color:var(--primary-light);
            box-shadow:0 0 0 1px rgba(124,58,237,0.6);
        }

        .scanner-btn{
            border-radius:999px;
            border:none;
            padding:10px 16px;
            font-size:13px;
            cursor:pointer;
            font-weight:600;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
        }
        .scanner-btn.primary{
            background:linear-gradient(135deg,var(--primary),var(--primary-light));
            color:#fff;
        }
        .scanner-btn.secondary{
            background:rgba(15,23,42,0.9);
            border:1px solid rgba(148,163,184,0.5);
            color:#e5e7eb;
        }
        .scanner-btn.danger{
            background:linear-gradient(135deg,#b91c1c,#ef4444);
            color:#fff;
        }

        .scanner-actions{
            display:flex;
            gap:8px;
            margin-top:12px;
            flex-wrap:wrap;
        }

        .offer-result{
            max-width:520px;
            background:radial-gradient(circle at top,#111827 0%,#020617 55%,#000 100%);
        }
        .offer-content{
            margin-top:10px;
            font-size:14px;
        }
        .offer-card{
            background:linear-gradient(145deg,rgba(15,23,42,0.95),rgba(15,23,42,0.6));
            border-radius:16px;
            padding:14px;
            border:1px solid rgba(148,163,184,0.3);
        }
        .search-results{
            max-height:320px;
            overflow-y:auto;
        }

        @media (max-width:480px){
            .scanner-modal-content{
                margin:12px;
                padding:14px;
            }
            .scanner-preview::after{
                inset:12px;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="logo">
            <img src="logo.png" alt="Rass 1 Hub" onerror="this.style.display='none'">
        </div>
        <div class="title">
            <h1>Rass 1 Hub - Scanner</h1>
            <p>Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Google Sheets</p>
        </div>

        <div class="card">
            <div class="main-actions">
                <button class="btn btn-primary" onclick="Scanner.start()">
                    ğŸ“· Ø§Ø¨Ø¯Ø£ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
                </button>
                <button class="btn btn-outline" onclick="Scanner.manualSearchFromHome()">
                    ğŸ” Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠ Ø¹Ù† Ø¹Ø±Ø¶
                </button>
            </div>
            <div class="hint">
                Ø§Ù„ØµÙØ­Ø© Ù…Ø³ØªÙ‚Ù„Ø© Ø¨Ø§Ø³Ù… <strong>scanner.html</strong><br>
                ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø´ÙŠØª ÙÙŠ Google Sheets Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¹Ø±Ø¶ Ù„Ø£ÙŠ Ø´Ø®Øµ Ù…Ø¹Ù‡ Ø§Ù„Ø±Ø§Ø¨Ø·.
            </div>
        </div>
    </div>

    <script>
    // === Barcode Scanner Module for Rass1 Hub (Standalone) ===

    let offersData = [];

    const Scanner = {
        scanner: null,
        isScanning: false,
        audioContext: null,
        isMobile: false,
        currentFacing: 'environment',
        searchResults: [],
        _offersLoaded: false,

        checkIsMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                || (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
        },

        async init() {
            if (!document.getElementById('scannerModal')) {
                this.createScannerModal();
            }
            if (!this._offersLoaded) {
                await this.loadOffersData();
                this._offersLoaded = true;
            }
        },

        createScannerModal() {
            const modalHTML = `
                <div id="scannerModal" class="scanner-modal">
                    <div class="scanner-modal-content">
                        <div class="scanner-header">
                            <h2 id="scannerModalTitle">ğŸ“· Scan Barcode</h2>
                            <button id="closeScannerBtn" class="scanner-close-btn">&times;</button>
                        </div>
                        
                        <div id="cameraSection">
                            <div id="scannerPreview" class="scanner-preview"></div>
                            <p class="scanner-hint">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</p>
                        </div>
                        
                        <div class="manual-search-section">
                            <div class="manual-search-divider" id="searchDivider">
                                <span>Ø£Ùˆ Ø§Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠØ§Ù‹</span>
                            </div>
                            <div class="manual-search-input">
                                <input type="text" id="manualSearchInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." />
                                <button id="manualSearchBtn" class="scanner-btn primary">ğŸ” Ø¨Ø­Ø«</button>
                            </div>
                        </div>
                        
                        <div class="scanner-actions" id="cameraActions">
                            <button id="switchCameraBtn" class="scanner-btn secondary">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                            <button id="stopScanBtn" class="scanner-btn danger">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­</button>
                        </div>
                    </div>
                </div>
                
                <div id="offerResultModal" class="scanner-modal">
                    <div class="scanner-modal-content offer-result">
                        <div class="scanner-header">
                            <h2 id="offerResultTitle">ğŸ‰ Offer Found!</h2>
                            <button id="closeOfferBtn" class="scanner-close-btn">&times;</button>
                        </div>
                        <div id="offerResultContent" class="offer-content"></div>
                        <div class="scanner-actions">
                            <button id="scanAgainBtn" class="scanner-btn primary">ğŸ” Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯</button>
                            <button id="closeOfferResultBtn" class="scanner-btn secondary">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            this.bindEvents();
        },

        bindEvents() {
            document.getElementById('closeScannerBtn')?.addEventListener('click', () => this.stop());
            document.getElementById('stopScanBtn')?.addEventListener('click', () => this.stop());
            document.getElementById('closeOfferBtn')?.addEventListener('click', () => this.closeOfferResult());
            document.getElementById('closeOfferResultBtn')?.addEventListener('click', () => this.closeOfferResult());
            document.getElementById('scanAgainBtn')?.addEventListener('click', () => {
                this.closeOfferResult();
                this.start();
            });
            document.getElementById('switchCameraBtn')?.addEventListener('click', () => this.switchCamera());

            const manualInput = document.getElementById('manualSearchInput');
            const manualBtn = document.getElementById('manualSearchBtn');

            if (manualInput) {
                manualInput.addEventListener('focus', () => {
                    if (this.isScanning && this.scanner) {
                        try { this.scanner.pause(true); } catch (e) {}
                    }
                });

                manualInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        manualInput.blur();
                        this.manualSearch();
                    }
                });
            }

            if (manualBtn) {
                manualBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    manualInput?.blur();
                    this.manualSearch();
                });
            }

            document.getElementById('scannerModal')?.addEventListener('click', (e) => {
                if (e.target.id === 'scannerModal') this.stop();
            });
        },

        async loadOffersData() {
            try {
                const sheetId = '1-_6mN6DpmuUbpgy3q3h-RXRjPepfhhcdIx2K3oybCzw';
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=0`;
                console.log('ğŸ”„ Fetching offers from:', url);
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/);
                if (!match || !match[1]) {
                    throw new Error('Unexpected response format from Google Sheets');
                }
                const data = JSON.parse(match[1]);
                offersData = this.parseGoogleSheetsData(data);
                console.log(`âœ… Offers loaded: ${offersData.length}`);
                if (!offersData.length) {
                    console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø±ÙˆØ¶ ÙÙŠ Ø§Ù„Ø´ÙŠØª (Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©)');
                }
            } catch (error) {
                console.error('âŒ Google Sheets Load Error:', error);
                offersData = this.getSampleData();
                console.log('ğŸ’¡ Using fallback sample data (local).');
            }
        },

        parseGoogleSheetsData(data) {
            if (!data?.table?.rows) return [];
            const rows = data.table.rows;
            const cols = data.table.cols.map(c => (c.label || '').toString().trim());
            console.log('ğŸ“‹ Sheet headers:', cols);

            // helper to find index by keywords
            const findIndex = (keywords) => {
                const lowerCols = cols.map(c => c.toLowerCase());
                for (let i = 0; i < lowerCols.length; i++) {
                    for (const k of keywords) {
                        if (lowerCols[i].includes(k)) return i;
                    }
                }
                return -1;
            };

            const idx = {
                barcode: findIndex(['barcode','Ø¨Ø§Ø±ÙƒÙˆØ¯','code','ÙƒÙˆØ¯']),
                productName: findIndex(['product','Ø§Ø³Ù…','Ø§Ù„Ù…Ù†ØªØ¬','Ø§Ù„ÙˆØµÙ Ø¨Ø§Ù„Ø§Ù†Ø¬']),
                brand: findIndex(['brand','Ù…Ø§Ø±ÙƒØ©','Ø´Ø±ÙƒØ©']),
                discount: findIndex(['discount','Ø®ØµÙ…','Ù†Ø³Ø¨Ø©']),
                priceBefore: findIndex(['before','Ø§Ù„Ø³Ø¹Ø± Ù‚Ø¨Ù„','price before']),
                save: findIndex(['save','ØªÙˆÙÙŠØ±','ÙØ±Ù‚']),
                priceAfter: findIndex(['after','Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯','price after']),
                startDate: findIndex(['start','Ø¨Ø¯Ø§ÙŠØ©','from','Ù…Ù†']),
                endDate: findIndex(['end','Ù†Ù‡Ø§ÙŠØ©','to','Ø¥Ù„Ù‰']),
                arDescription: findIndex(['arabic','ÙˆØµÙ Ø¹Ø±Ø¨ÙŠ','Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ','Ø§Ù„ÙˆØµÙ']),
                type: findIndex(['type','Ù†ÙˆØ¹','ÙØ¦Ø© Ø§Ù„Ø¹Ø±Ø¶']),
                category: findIndex(['category','ØªØµÙ†ÙŠÙ','Ù‚Ø³Ù…'])
            };

            // fallback to fixed positions if not detected
            const fallback = {
                barcode: 0,
                productName: 1,
                brand: 2,
                discount: 3,
                priceBefore: 4,
                save: 5,
                priceAfter: 6,
                startDate: 8,
                endDate: 9,
                arDescription: 10,
                type: 11,
                category: 12
            };

            const getIdx = (key) => (idx[key] !== -1 ? idx[key] : fallback[key]);

            const extractDate = (cell) => {
                if (!cell) return '';
                if (cell.f && cell.f !== 'âˆ') return cell.f;
                if (cell.v !== null && cell.v !== undefined) {
                    const vs = String(cell.v);
                    const m = vs.match(/Date\((\d+),(\d+),(\d+)\)/);
                    if (m) return `${parseInt(m[1])}/${parseInt(m[2]) + 1}/${m[3]}`;
                    if (!isNaN(cell.v) && cell.v > 40000 && cell.v < 60000) {
                        const d = new Date((cell.v - 25569) * 86400000);
                        return `${d.getMonth() + 1}/${d.getDate()}/${d.getFullYear()}`;
                    }
                    return vs;
                }
                return '';
            };

            // detect if first row is header (non-numeric barcode)
            const firstRow = rows[0];
            const fvCell = firstRow?.c?.[getIdx('barcode')];
            const fv = fvCell?.f || fvCell?.v;
            const firstLooksLikeBarcode =
                fv && !isNaN(String(fv).replace(/\D/g, '')) && String(fv).replace(/\D/g, '').length >= 6;
            const startIdx = firstLooksLikeBarcode ? 0 : 1;

            const items = rows.slice(startIdx).map((row) => {
                const cells = row.c || [];
                const getCell = (i) => (i >= 0 && i < cells.length ? cells[i] : null);

                const bcCell = getCell(getIdx('barcode'));
                const barcode = (bcCell?.f || bcCell?.v || '').toString().trim();
                if (!barcode) return null;

                return {
                    barcode,
                    productName: (getCell(getIdx('productName'))?.v || getCell(getIdx('productName'))?.f || '').toString(),
                    brand: (getCell(getIdx('brand'))?.v || '').toString(),
                    discount: (getCell(getIdx('discount'))?.v || getCell(getIdx('discount'))?.f || '').toString(),
                    priceBefore: (getCell(getIdx('priceBefore'))?.v || getCell(getIdx('priceBefore'))?.f || '').toString(),
                    save: (getCell(getIdx('save'))?.v || getCell(getIdx('save'))?.f || '').toString(),
                    priceAfter: (getCell(getIdx('priceAfter'))?.v || getCell(getIdx('priceAfter'))?.f || '').toString(),
                    startDate: extractDate(getCell(getIdx('startDate'))),
                    endDate: extractDate(getCell(getIdx('endDate'))),
                    arDescription: (getCell(getIdx('arDescription'))?.v || '').toString(),
                    type: (getCell(getIdx('type'))?.v || '').toString(),
                    category: (getCell(getIdx('category'))?.v || '').toString()
                };
            }).filter(Boolean);

            console.log('âœ… Parsed offers from sheet:', items.length);
            return items;
        },

        parseDate(dateStr) {
            if (!dateStr || dateStr === 'âˆ' || String(dateStr).toLowerCase().includes('inf')) {
                return null;
            }
            try {
                let date = new Date(dateStr);
                if (!isNaN(date.getTime())) return date;
                const parts = String(dateStr).split(/[\/\-.]/);
                if (parts.length === 3) {
                    const p0 = parseInt(parts[0]);
                    const p1 = parseInt(parts[1]);
                    const y = parseInt(parts[2]);
                    if (y > 1000) {
                        if (p0 > 12) return new Date(y, p1 - 1, p0);
                        return new Date(y, p0 - 1, p1);
                    }
                }
                return null;
            } catch {
                return null;
            }
        },

        getOfferStatus(offer) {
            if (offer.type === 'Ø«Ø§Ø¨Øª') {
                return {
                    status: 'active',
                    label: 'âœ… Ø³Ø§Ø±ÙŠ',
                    color: '#27ae60',
                    message: 'Ø¹Ø±Ø¶ Ù…Ø³ØªÙ…Ø±'
                };
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const startDate = this.parseDate(offer.startDate);
            const endDate = this.parseDate(offer.endDate);

            if (startDate && startDate > today) {
                const diff = Math.ceil((startDate - today) / 86400000);
                return {
                    status: 'not_started',
                    label: 'ğŸ”œ Ù„Ù… ÙŠØ¨Ø¯Ø£',
                    color: '#95a5a6',
                    message: `Ø¨Ø¹Ø¯ ${diff} ÙŠÙˆÙ…`
                };
            }

            if (endDate && endDate < today) {
                return {
                    status: 'expired',
                    label: 'âŒ Ù…Ù†ØªÙ‡ÙŠ',
                    color: '#e74c3c',
                    message: 'Ø§Ù†ØªÙ‡Ù‰'
                };
            }

            if (endDate) {
                const diff = Math.ceil((endDate - today) / 86400000);
                if (diff <= 3) {
                    return {
                        status: 'ending_soon',
                        label: 'âš¡ ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹',
                        color: '#f39c12',
                        message: `${diff} ÙŠÙˆÙ…`
                    };
                }
                return {
                    status: 'active',
                    label: 'âœ… Ø³Ø§Ø±ÙŠ',
                    color: '#27ae60',
                    message: `${diff} ÙŠÙˆÙ…`
                };
            }

            return {
                status: 'active',
                label: 'âœ… Ø³Ø§Ø±ÙŠ',
                color: '#27ae60',
                message: 'Ù…Ø³ØªÙ…Ø±'
            };
        },

        getSampleData() {
            return [
                {
                    barcode: '3616303321932',
                    productName: 'ADIDAS ICE DIVE NATURAL SPRAY 100ML',
                    brand: 'ADIDAS',
                    discount: '20.00%',
                    priceBefore: '48',
                    save: '9.6',
                    priceAfter: '38.47',
                    arDescription: 'Ø¨Ø®Ø§Ø® Ø£Ø¯ÙŠØ¯Ø§Ø³ Ø¢ÙŠØ³ Ø¯Ø§ÙŠÙ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ 100 Ù…Ù„',
                    category: 'COSMETICS',
                    type: 'Ø«Ø§Ø¨Øª'
                }
            ];
        },

        async loadHtml5QrcodeLib() {
            if (typeof Html5Qrcode !== 'undefined') return;
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/html5-qrcode';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        },

        async start() {
            await this.init();

            if (typeof Html5Qrcode === 'undefined') {
                try {
                    await this.loadHtml5QrcodeLib();
                } catch (e) {
                    console.error('Failed to load Html5Qrcode:', e);
                }
            }

            this.isMobile = this.checkIsMobile();
            const modal = document.getElementById('scannerModal');
            const cameraSection = document.getElementById('cameraSection');
            const cameraActions = document.getElementById('cameraActions');
            const searchDivider = document.getElementById('searchDivider');
            const modalTitle = document.getElementById('scannerModalTitle');
            const searchInput = document.getElementById('manualSearchInput');

            modal.classList.add('active');

            if (!this.isMobile || typeof Html5Qrcode === 'undefined') {
                modalTitle.textContent = 'ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶';
                cameraSection.style.display = 'none';
                cameraActions.style.display = 'none';
                searchDivider.style.display = 'none';
                setTimeout(() => searchInput?.focus(), 100);
                return;
            }

            modalTitle.textContent = 'ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯';
            cameraSection.style.display = 'block';
            cameraActions.style.display = 'flex';
            searchDivider.style.display = 'flex';

            try {
                this.scanner = new Html5Qrcode('scannerPreview');
                this.currentFacing = 'environment';
                await this._startCamera();
            } catch (error) {
                console.error('Scanner start error:', error);
                cameraSection.style.display = 'none';
                cameraActions.style.display = 'none';
                searchDivider.style.display = 'none';
                modalTitle.textContent = 'ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶';
                setTimeout(() => searchInput?.focus(), 100);
            }
        },

        async _startCamera() {
            if (!this.scanner) return;
            const config = {
                fps: 20,
                qrbox: { width: 300, height: 150 },
                aspectRatio: 1.777778,
                experimentalFeatures: { useBarCodeDetectorIfSupported: true }
            };
            await this.scanner.start(
                { facingMode: this.currentFacing || 'environment' },
                config,
                (decodedText) => this.onScanSuccess(decodedText),
                () => {}
            );
            this.isScanning = true;
        },

        async stop() {
            if (this.scanner && this.isScanning) {
                try {
                    await this.scanner.stop();
                } catch (e) {}
            }
            this.isScanning = false;
            document.getElementById('scannerModal')?.classList.remove('active');
        },

        async switchCamera() {
            if (!this.scanner) return;
            try {
                if (this.isScanning) {
                    await this.scanner.stop();
                }
                this.isScanning = false;
                this.currentFacing = this.currentFacing === 'environment' ? 'user' : 'environment';
                await this._startCamera();
            } catch (error) {
                console.error('Camera switch error:', error);
            }
        },

        onScanSuccess(barcode) {
            console.log('ğŸ“· Scanned barcode:', barcode);
            this.playBeepSound();
            this.stop();
            const offer = this.lookupOffer(barcode);
            this.showResult(barcode, offer);
        },

        playBeepSound() {
            try {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                const ctx = this.audioContext;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                oscillator.frequency.value = 1800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.1);
            } catch (e) {
                console.log('Beep error:', e);
            }
        },

        lookupOffer(barcode) {
            return offersData.find(item => item.barcode === barcode);
        },

        searchByName(query) {
            const lowerQuery = query.toLowerCase();
            return offersData.filter(item =>
                item.productName?.toLowerCase().includes(lowerQuery) ||
                item.arDescription?.toLowerCase().includes(lowerQuery) ||
                item.brand?.toLowerCase().includes(lowerQuery) ||
                item.category?.toLowerCase().includes(lowerQuery)
            );
        },

        manualSearch() {
            const input = document.getElementById('manualSearchInput');
            const query = input?.value?.trim();
            if (!query) return;

            this.stop();

            let offer = this.lookupOffer(query);
            if (offer) {
                this.showResult(query, offer);
            } else {
                const results = this.searchByName(query);
                if (results.length === 1) {
                    this.showResult(results[0].barcode, results[0]);
                } else if (results.length > 1) {
                    this.showMultipleResults(results);
                } else {
                    this.showResult(query, null);
                }
            }
            if (input) input.value = '';
        },

        manualSearchFromHome() {
            this.init().then(() => {
                const modal = document.getElementById('scannerModal');
                const cameraSection = document.getElementById('cameraSection');
                const cameraActions = document.getElementById('cameraActions');
                const searchDivider = document.getElementById('searchDivider');
                const modalTitle = document.getElementById('scannerModalTitle');
                const searchInput = document.getElementById('manualSearchInput');

                modal.classList.add('active');
                modalTitle.textContent = 'ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶';
                cameraSection.style.display = 'none';
                cameraActions.style.display = 'none';
                searchDivider.style.display = 'none';
                setTimeout(() => searchInput?.focus(), 100);
            });
        },

        showMultipleResults(results) {
            const modal = document.getElementById('offerResultModal');
            const title = document.getElementById('offerResultTitle');
            const content = document.getElementById('offerResultContent');

            title.textContent = `ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${results.length} Ù†ØªØ§Ø¦Ø¬`;
            title.style.color = '#3498db';

            let html = '<div class="search-results">';
            results.forEach((item, index) => {
                html += `
                    <div class="search-result-item" onclick="Scanner.selectResult(${index})"
                        style="padding: 12px; border-bottom: 1px solid rgba(148,163,184,0.3); cursor: pointer;">
                        <div style="font-weight: bold; color: #a5b4fc;">${item.brand || ''}</div>
                        <div style="color: #e5e7eb; margin: 5px 0;">${item.productName}</div>
                        <div style="font-size: 0.9em; color: #2ecc71;">
                            ${item.priceAfter} SAR
                            <span style="text-decoration: line-through; color: #9ca3af; font-size: 0.8em; margin-right:8px;">
                                ${item.priceBefore} SAR
                            </span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            content.innerHTML = html;
            modal.classList.add('active');
            this.searchResults = results;
        },

        selectResult(index) {
            if (this.searchResults && this.searchResults[index]) {
                this.showResult(this.searchResults[index].barcode, this.searchResults[index]);
            }
        },

        showResult(barcode, offer) {
            const modal = document.getElementById('offerResultModal');
            const title = document.getElementById('offerResultTitle');
            const content = document.getElementById('offerResultContent');

            if (offer) {
                const status = this.getOfferStatus(offer);
                title.textContent = 'ğŸ‰ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶!';
                title.style.color = '#27ae60';
                content.innerHTML = `
                    <div class="offer-card">
                        <div class="offer-status-banner"
                             style="background:${status.color}; padding: 8px 10px; border-radius: 10px; margin-bottom: 12px; text-align: center; color: white; font-size: 13px;">
                            <span style="font-weight: bold;">${status.label}</span>
                            <span style="margin-inline:6px;">|</span>
                            <span>${status.message}</span>
                        </div>
                        <div class="offer-product" style="text-align: center; margin-bottom: 12px;">
                            <span style="background: #4f46e5; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; color: white;">
                                ${offer.brand}
                            </span>
                            <h3 style="color: white; margin: 10px 0 6px; font-size: 15px;">
                                ${offer.productName}
                            </h3>
                            <p style="color: #9ca3af; font-size: 0.9em;">
                                ${offer.arDescription || ''}
                            </p>
                        </div>
                        <div class="offer-pricing" style="background: rgba(15,23,42,0.85); padding: 12px; border-radius: 12px; font-size: 13px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                                <span style="color:#9ca3af;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ:</span>
                                <span style="text-decoration: line-through; color: #f87171;">
                                    ${offer.priceBefore} SAR
                                </span>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                                <span style="color:#9ca3af;">Ø§Ù„Ø®ØµÙ…:</span>
                                <span style="background:#ef4444; padding:2px 8px; border-radius:999px; font-size:0.85em; color:white;">
                                    ${offer.discount}
                                </span>
                            </div>
                            <div style="display:flex; justify-content:space-between; border-top:1px solid rgba(148,163,184,0.5); padding-top:8px; margin-top:8px;">
                                <span style="font-weight:bold; color:#e5e7eb;">Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶:</span>
                                <span style="font-size:1.3em; font-weight:bold; color:#22c55e;">
                                    ${offer.priceAfter} SAR
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                title.textContent = 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶';
                title.style.color = '#e74c3c';
                content.innerHTML = `
                    <div style="text-align:center; color:#e5e7eb; padding:18px 10px;">
                        <div style="background: rgba(15,23,42,0.85); padding: 12px; border-radius: 12px; margin-bottom: 12px; font-family: monospace; font-size: 13px;">
                            ${barcode}
                        </div>
                        <p style="font-size:13px; color:#d1d5db;">
                            Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ù‡ Ø¹Ø±Ø¶ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
                        </p>
                    </div>
                `;
            }

            modal.classList.add('active');
        },

        closeOfferResult() {
            document.getElementById('offerResultModal')?.classList.remove('active');
        }
    };

    window.Scanner = Scanner;

    // ÙŠÙØªØ­ Ø§Ù„Ø³ÙƒØ§Ù†Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', () => {
        Scanner.start();
    });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rass 1 Hub - Scanner</title>
  <link rel="icon" href="logo.png" type="image/png">

  <style>
    :root{
      --primary:#561C2C;
      --primary-light:#7a2840;
      --accent:#8DC63F;
      --danger:#ef4444;
      --warn:#f59e0b;
      --info:#3b82f6;
      --bg1:#0b1220;
      --bg2:#020617;
      --card:rgba(15,23,42,0.9);
      --border:rgba(148,163,184,0.25);
      --text:#e5e7eb;
      --muted:#9ca3af;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      min-height:100vh;
      background:radial-gradient(circle at top, var(--bg1) 0%, var(--bg2) 55%, #000 100%);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{max-width:520px;width:100%}
    .top{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:12px}
    .top img{height:64px;filter:drop-shadow(0 2px 6px rgba(0,0,0,0.45))}
    .title{text-align:center;margin-bottom:14px}
    .title h1{font-size:18px;color:#f9fafb;margin-bottom:5px}
    .title p{font-size:12px;color:var(--muted);line-height:1.5}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 18px 50px rgba(0,0,0,0.7);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:none;border-radius:999px;padding:12px 16px;
      cursor:pointer;font-weight:700;font-size:13px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      transition:.25s;flex:1;min-width:180px;
      user-select:none;
    }
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff}
    .btn.primary:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(86,28,44,0.55)}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(148,163,184,0.45)}
    .btn.ghost:hover{background:rgba(15,23,42,0.85)}
    .btn.danger{background:linear-gradient(135deg,#b91c1c,#ef4444);color:#fff}
    .btn.info{background:linear-gradient(135deg,#1d4ed8,#3b82f6);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none!important;box-shadow:none!important}

    .status{
      margin-top:12px;
      background:rgba(2,6,23,0.6);
      border:1px solid rgba(148,163,184,0.25);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .status-line{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-size:12px;color:var(--muted);
    }
    .pill{
      font-size:11px;font-weight:800;letter-spacing:.2px;
      padding:4px 10px;border-radius:999px;color:#fff;white-space:nowrap;
    }
    .pill.ok{background:#16a34a}
    .pill.warn{background:#f59e0b}
    .pill.err{background:#ef4444}
    .pill.info{background:#3b82f6}

    /* Modal */
    .modal{
      position:fixed;inset:0;
      background:rgba(2,6,23,0.92);
      backdrop-filter:blur(7px);
      display:flex;align-items:center;justify-content:center;
      opacity:0;visibility:hidden;
      transition:.25s;
      z-index:9999;
      padding:14px;
    }
    .modal.active{opacity:1;visibility:visible}
    .modal-box{
      width:100%;max-width:560px;
      background:radial-gradient(circle at top, #111827 0%, #020617 55%, #000 100%);
      border:1px solid rgba(148,163,184,0.35);
      border-radius:18px;
      padding:14px;
      box-shadow:0 25px 70px rgba(0,0,0,0.85);
    }
    .modal-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .modal-head h2{font-size:15px}
    .x{
      background:transparent;border:none;color:var(--muted);
      font-size:22px;cursor:pointer;line-height:1;
      padding:4px 8px;border-radius:10px;
    }
    .x:hover{color:#fff;background:rgba(148,163,184,0.15)}
    .preview{
      width:100%;
      aspect-ratio:16/10;
      border-radius:16px;
      overflow:hidden;
      background:#000;
      position:relative;
      border:1px solid rgba(148,163,184,0.25);
    }
    /* Overlay Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù…Ø³ØªØ·ÙŠÙ„ Ø¹Ø±ÙŠØ¶) */
    .preview::after{
      content:'';
      position:absolute;
      left:10%;
      right:10%;
      top:36%;
      bottom:36%;
      border-radius:14px;
      border:2px dashed rgba(248,250,252,0.55);
      box-shadow:0 0 0 999px rgba(0,0,0,0.35);
      pointer-events:none;
    }
    .hint{margin-top:8px;text-align:center;color:var(--muted);font-size:12px;line-height:1.5}
    .manual{
      margin-top:12px;
      background:rgba(2,6,23,0.55);
      border:1px solid rgba(148,163,184,0.25);
      border-radius:16px;
      padding:10px;
    }
    .divider{
      display:flex;align-items:center;justify-content:center;gap:10px;
      color:var(--muted);font-size:11px;margin-bottom:8px;
    }
    .divider:before,.divider:after{
      content:'';
      flex:1;height:1px;
      background:linear-gradient(to left, transparent, rgba(148,163,184,0.7));
    }
    .divider:after{background:linear-gradient(to right, transparent, rgba(148,163,184,0.7))}
    .manual-row{display:flex;gap:8px;flex-wrap:wrap}
    .manual-row input{
      flex:1;min-width:180px;
      padding:11px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background:rgba(15,23,42,0.9);
      color:var(--text);
      font-size:13px;
      outline:none;
    }
    .manual-row input:focus{
      border-color:rgba(122,40,64,0.9);
      box-shadow:0 0 0 2px rgba(122,40,64,0.35);
    }
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* Result modal */
    .result-body{margin-top:10px}
    .offer-card{
      background:linear-gradient(145deg,rgba(15,23,42,0.95),rgba(15,23,42,0.6));
      border:1px solid rgba(148,163,184,0.3);
      border-radius:16px;
      padding:12px;
    }
    .banner{
      padding:8px 10px;border-radius:12px;color:#fff;
      display:flex;justify-content:center;gap:10px;align-items:center;
      font-weight:800;font-size:12px;margin-bottom:10px;
    }
    .kv{
      display:flex;justify-content:space-between;gap:10px;
      padding:7px 8px;border-radius:12px;
      background:rgba(2,6,23,0.55);
      border:1px solid rgba(148,163,184,0.22);
      margin-top:8px;
      font-size:13px;
    }
    .kv span:first-child{color:var(--muted)}
    .big{
      font-size:18px;font-weight:900;color:#22c55e;
    }
    .strike{color:#f87171;text-decoration:line-through;font-weight:800}
    .tag{
      display:inline-block;
      padding:3px 10px;border-radius:999px;
      background:#4f46e5;color:#fff;
      font-size:11px;font-weight:900;
      margin-bottom:8px;
    }
    .results-list{
      max-height:320px;overflow:auto;
      border-radius:14px;border:1px solid rgba(148,163,184,0.25);
      background:rgba(2,6,23,0.55);
    }
    .res-item{
      padding:10px 12px;border-bottom:1px solid rgba(148,163,184,0.2);
      cursor:pointer;
    }
    .res-item:hover{background:rgba(148,163,184,0.12)}
    .res-item .b{font-weight:900;color:#a5b4fc;font-size:12px}
    .res-item .n{margin-top:4px;color:#e5e7eb;font-size:13px}
    .res-item .p{margin-top:6px;color:#22c55e;font-weight:900;font-size:12px}
    .mini{color:var(--muted);font-size:11px;margin-right:8px;text-decoration:line-through}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <img src="logo.png" alt="Rass 1 Hub" onerror="this.style.display='none'">
    </div>

    <div class="title">
      <h1>Rass 1 Hub â€” Scanner</h1>
      <p>ÙŠÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ + ÙŠØ¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù…Ù† Google Sheets</p>
    </div>

    <div class="card">
      <div class="row">
        <button id="openScannerBtn" class="btn primary">ğŸ“· ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¢Ù†</button>
        <button id="openSearchBtn" class="btn ghost">ğŸ” Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠ</button>
      </div>

      <div class="status">
        <div class="status-line">
          <span>Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ (Google Sheets)</span>
          <span id="dbPill" class="pill info">... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</span>
        </div>
        <div class="status-line">
          <span>Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ / Ø§Ù„Ø³ÙƒØ§Ù†Ø±</span>
          <span id="camPill" class="pill info">Ø¬Ø§Ù‡Ø²</span>
        </div>
        <div class="status-line" id="statusMsg" style="justify-content:flex-start;gap:8px;">
          <span style="color:var(--muted);font-size:11px;line-height:1.6;">
            Ø¥Ø°Ø§ Ø§Ù„Ø´ÙŠØª Ù…Ùˆ Public Ø£Ùˆ Ù…Ùˆ â€œPublishedâ€ØŒ Ø¨ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©.
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div id="scannerModal" class="modal">
    <div class="modal-box">
      <div class="modal-head">
        <h2 id="scannerTitle">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h2>
        <button class="x" id="closeScanner">Ã—</button>
      </div>

      <div id="cameraArea">
        <div id="scannerPreview" class="preview"></div>
        <div class="hint" id="scanHint">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ (EAN/UPC/Code128...)</div>
      </div>

      <div class="manual">
        <div class="divider" id="divider">Ø£Ùˆ Ø§Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠØ§Ù‹</div>
        <div class="manual-row">
          <input id="manualInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." />
          <button id="manualBtn" class="btn info" style="min-width:130px;flex:0">Ø¨Ø­Ø«</button>
        </div>
      </div>

      <div class="actions" id="cameraActions">
        <button id="switchCam" class="btn ghost" style="min-width:160px">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button id="stopScan" class="btn danger" style="min-width:160px">Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>
    </div>
  </div>

  <!-- Result Modal -->
  <div id="resultModal" class="modal">
    <div class="modal-box">
      <div class="modal-head">
        <h2 id="resultTitle">Ø§Ù„Ù†ØªÙŠØ¬Ø©</h2>
        <button class="x" id="closeResult">Ã—</button>
      </div>
      <div class="result-body" id="resultBody"></div>
      <div class="actions">
        <button id="scanAgain" class="btn primary" style="min-width:160px">ğŸ“· Ù…Ø³Ø­ Ø¬Ø¯ÙŠØ¯</button>
        <button id="closeResult2" class="btn ghost" style="min-width:160px">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const SHEET_ID = '1-_6mN6DpmuUbpgy3q3h-RXRjPepfhhcdIx2K3oybCzw';
    const SHEET_GID = 0;

    // ====== STATE ======
    let offersData = [];
    let offersLoaded = false;

    // ====== UI HELPERS ======
    const UI = {
      dbPill: () => document.getElementById('dbPill'),
      camPill: () => document.getElementById('camPill'),
      statusMsg: () => document.getElementById('statusMsg'),

      setDb(status, text){
        const pill = UI.dbPill();
        pill.className = 'pill ' + status;
        pill.textContent = text;
      },
      setCam(status, text){
        const pill = UI.camPill();
        pill.className = 'pill ' + status;
        pill.textContent = text;
      },
      setMsg(msg, color='var(--muted)'){
        const el = UI.statusMsg();
        el.innerHTML = `<span style="color:${color};font-size:11px;line-height:1.6;">${msg}</span>`;
      },
      open(id){ document.getElementById(id)?.classList.add('active'); },
      close(id){ document.getElementById(id)?.classList.remove('active'); },
    };

    // ====== CSV PARSER (robust enough) ======
    function parseCSV(text){
      const rows = [];
      let cur = '';
      let inQuotes = false;
      let row = [];

      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];

        if(ch === '"' && inQuotes && next === '"'){
          cur += '"'; i++;
          continue;
        }
        if(ch === '"'){
          inQuotes = !inQuotes;
          continue;
        }
        if(ch === ',' && !inQuotes){
          row.push(cur); cur = '';
          continue;
        }
        if((ch === '\n' || ch === '\r') && !inQuotes){
          if(ch === '\r' && next === '\n') i++;
          row.push(cur); cur = '';
          if(row.length > 1 || (row.length === 1 && row[0].trim() !== '')){
            rows.push(row);
          }
          row = [];
          continue;
        }
        cur += ch;
      }
      // last
      if(cur.length || row.length){
        row.push(cur);
        if(row.length > 1 || (row.length === 1 && row[0].trim() !== '')){
          rows.push(row);
        }
      }
      return rows;
    }

    // ====== SHEETS LOADERS (3 Ø·Ø±Ù‚) ======
    function gvizUrl(){
      return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;
    }
    function exportCsvUrl(){
      return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
    }
    function publishedCsvUrl(){
      // Ø¥Ø°Ø§ Ø§Ù„Ø´ÙŠØª "Published to web" ØºØ§Ù„Ø¨Ø§Ù‹ Ù‡Ø°Ø§ ÙŠØ´ØªØºÙ„
      return `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?output=csv`;
    }

    async function fetchText(url){
      const r = await fetch(url, { cache: 'no-store' });
      const t = await r.text();
      return { ok: r.ok, status: r.status, text: t };
    }

    function looksLikeLoginHtml(t){
      const s = (t||'').toLowerCase();
      return s.includes('<!doctype html') && (s.includes('accounts.google.com') || s.includes('signin') || s.includes('service-login'));
    }

    function parseOffersFromGviz(gvizText){
      const match = gvizText.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/);
      if(!match || !match[1]) throw new Error('GVIZ format mismatch');
      const data = JSON.parse(match[1]);
      if(!data?.table?.rows) return [];

      const cols = (data.table.cols || []).map(c => (c.label || '').toString().trim());
      const rows = data.table.rows;

      // find index by keywords in headers (Arabic/English)
      const findIndex = (keywords) => {
        const lower = cols.map(c => c.toLowerCase());
        for(let i=0;i<lower.length;i++){
          for(const k of keywords){
            if(lower[i].includes(k)) return i;
          }
        }
        return -1;
      };

      const idx = {
        barcode: findIndex(['barcode','Ø¨Ø§Ø±ÙƒÙˆØ¯','code','ÙƒÙˆØ¯']),
        productName: findIndex(['product','Ø§Ø³Ù…','Ø§Ù„Ù…Ù†ØªØ¬','name','Ø§Ù„ÙˆØµÙ']),
        brand: findIndex(['brand','Ù…Ø§Ø±ÙƒØ©','Ø´Ø±ÙƒØ©']),
        discount: findIndex(['discount','Ø®ØµÙ…','Ù†Ø³Ø¨Ø©']),
        priceBefore: findIndex(['before','Ø§Ù„Ø³Ø¹Ø± Ù‚Ø¨Ù„','price before','old']),
        save: findIndex(['save','ØªÙˆÙÙŠØ±','ÙØ±Ù‚']),
        priceAfter: findIndex(['after','Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯','price after','new']),
        startDate: findIndex(['start','Ø¨Ø¯Ø§ÙŠØ©','from','Ù…Ù†']),
        endDate: findIndex(['end','Ù†Ù‡Ø§ÙŠØ©','to','Ø¥Ù„Ù‰']),
        arDescription: findIndex(['arabic','Ø¹Ø±Ø¨ÙŠ','Ø§Ù„ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠ','ar']),
        type: findIndex(['type','Ù†ÙˆØ¹']),
        category: findIndex(['category','ØªØµÙ†ÙŠÙ','Ù‚Ø³Ù…'])
      };

      const fallback = {
        barcode: 0,
        productName: 1,
        brand: 2,
        discount: 3,
        priceBefore: 4,
        save: 5,
        priceAfter: 6,
        startDate: 8,
        endDate: 9,
        arDescription: 10,
        type: 11,
        category: 12
      };

      const getIdx = (key) => (idx[key] !== -1 ? idx[key] : fallback[key]);

      const extractDate = (cell) => {
        if(!cell) return '';
        if(cell.f && cell.f !== 'âˆ') return cell.f;
        if(cell.v !== null && cell.v !== undefined){
          const vs = String(cell.v);
          const m = vs.match(/Date\((\d+),(\d+),(\d+)\)/);
          if(m) return `${parseInt(m[1])}/${parseInt(m[2])+1}/${m[3]}`;
          if(!isNaN(cell.v) && cell.v > 40000 && cell.v < 60000){
            const d = new Date((cell.v - 25569) * 86400000);
            return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
          }
          return vs;
        }
        return '';
      };

      // detect header row (if first row barcode looks non-numeric)
      const first = rows[0]?.c?.[getIdx('barcode')];
      const fv = (first?.f || first?.v || '').toString();
      const firstLooksBarcode = fv && fv.replace(/\D/g,'').length >= 6;
      const startAt = firstLooksBarcode ? 0 : 1;

      const items = rows.slice(startAt).map(row => {
        const c = row.c || [];
        const cell = (i) => (i>=0 && i<c.length ? c[i] : null);

        const bcCell = cell(getIdx('barcode'));
        const barcode = (bcCell?.f || bcCell?.v || '').toString().trim();
        if(!barcode) return null;

        return {
          barcode,
          productName: (cell(getIdx('productName'))?.v || cell(getIdx('productName'))?.f || '').toString().trim(),
          brand: (cell(getIdx('brand'))?.v || cell(getIdx('brand'))?.f || '').toString().trim(),
          discount: (cell(getIdx('discount'))?.v || cell(getIdx('discount'))?.f || '').toString().trim(),
          priceBefore: (cell(getIdx('priceBefore'))?.v || cell(getIdx('priceBefore'))?.f || '').toString().trim(),
          save: (cell(getIdx('save'))?.v || cell(getIdx('save'))?.f || '').toString().trim(),
          priceAfter: (cell(getIdx('priceAfter'))?.v || cell(getIdx('priceAfter'))?.f || '').toString().trim(),
          startDate: extractDate(cell(getIdx('startDate'))),
          endDate: extractDate(cell(getIdx('endDate'))),
          arDescription: (cell(getIdx('arDescription'))?.v || cell(getIdx('arDescription'))?.f || '').toString().trim(),
          type: (cell(getIdx('type'))?.v || cell(getIdx('type'))?.f || '').toString().trim(),
          category: (cell(getIdx('category'))?.v || cell(getIdx('category'))?.f || '').toString().trim(),
        };
      }).filter(Boolean);

      return items;
    }

    function parseOffersFromCsv(csvText){
      const rows = parseCSV(csvText);
      if(!rows.length) return [];

      const header = rows[0].map(h => (h||'').toString().trim());
      const lower = header.map(h => h.toLowerCase());

      const find = (keywords) => {
        for(let i=0;i<lower.length;i++){
          for(const k of keywords){
            if(lower[i].includes(k)) return i;
          }
        }
        return -1;
      };

      const idx = {
        barcode: find(['barcode','Ø¨Ø§Ø±ÙƒÙˆØ¯','code','ÙƒÙˆØ¯']),
        productName: find(['product','Ø§Ø³Ù…','Ø§Ù„Ù…Ù†ØªØ¬','name','Ø§Ù„ÙˆØµÙ']),
        brand: find(['brand','Ù…Ø§Ø±ÙƒØ©','Ø´Ø±ÙƒØ©']),
        discount: find(['discount','Ø®ØµÙ…','Ù†Ø³Ø¨Ø©']),
        priceBefore: find(['before','Ø§Ù„Ø³Ø¹Ø± Ù‚Ø¨Ù„','price before','old']),
        save: find(['save','ØªÙˆÙÙŠØ±','ÙØ±Ù‚']),
        priceAfter: find(['after','Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯','price after','new']),
        startDate: find(['start','Ø¨Ø¯Ø§ÙŠØ©','from','Ù…Ù†']),
        endDate: find(['end','Ù†Ù‡Ø§ÙŠØ©','to','Ø¥Ù„Ù‰']),
        arDescription: find(['arabic','Ø¹Ø±Ø¨ÙŠ','Ø§Ù„ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠ','ar']),
        type: find(['type','Ù†ÙˆØ¹']),
        category: find(['category','ØªØµÙ†ÙŠÙ','Ù‚Ø³Ù…'])
      };

      const fallback = {
        barcode: 0,
        productName: 1,
        brand: 2,
        discount: 3,
        priceBefore: 4,
        save: 5,
        priceAfter: 6,
        startDate: 8,
        endDate: 9,
        arDescription: 10,
        type: 11,
        category: 12
      };
      const getIdx = (key) => (idx[key] !== -1 ? idx[key] : fallback[key]);

      const items = rows.slice(1).map(r => {
        const v = (i) => (i>=0 && i<r.length ? (r[i]||'').toString().trim() : '');
        const barcode = v(getIdx('barcode'));
        if(!barcode) return null;
        return {
          barcode,
          productName: v(getIdx('productName')),
          brand: v(getIdx('brand')),
          discount: v(getIdx('discount')),
          priceBefore: v(getIdx('priceBefore')),
          save: v(getIdx('save')),
          priceAfter: v(getIdx('priceAfter')),
          startDate: v(getIdx('startDate')),
          endDate: v(getIdx('endDate')),
          arDescription: v(getIdx('arDescription')),
          type: v(getIdx('type')),
          category: v(getIdx('category')),
        };
      }).filter(Boolean);

      return items;
    }

    async function loadOffers(){
      UI.setDb('info','... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„');
      UI.setMsg('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù…Ù† Google Sheets...');

      // 1) GVIZ
      try{
        const { ok, status, text } = await fetchText(gvizUrl());
        if(!ok) throw new Error(`GVIZ HTTP ${status}`);
        if(looksLikeLoginHtml(text)) throw new Error('GVIZ needs permission (login page)');
        const items = parseOffersFromGviz(text);
        if(items.length){
          offersData = items;
          offersLoaded = true;
          UI.setDb('ok', `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${items.length}`);
          UI.setMsg('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
          return;
        }
        // Ø¥Ø°Ø§ Ø±Ø¬Ø¹Øª ÙØ§Ø¶ÙŠØ© Ù†Ø¬Ø±Ù‘Ø¨ CSV
      }catch(e){
        console.warn('GVIZ load failed:', e);
      }

      // 2) Export CSV
      try{
        const { ok, status, text } = await fetchText(exportCsvUrl());
        if(!ok) throw new Error(`CSV export HTTP ${status}`);
        if(looksLikeLoginHtml(text)) throw new Error('CSV export needs permission (login page)');
        const items = parseOffersFromCsv(text);
        if(items.length){
          offersData = items;
          offersLoaded = true;
          UI.setDb('ok', `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${items.length}`);
          UI.setMsg('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
          return;
        }
      }catch(e){
        console.warn('CSV export failed:', e);
      }

      // 3) Published CSV (Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø¥Ù„Ø§ Ù„Ùˆ Published to web)
      try{
        const { ok, status, text } = await fetchText(publishedCsvUrl());
        if(!ok) throw new Error(`Published CSV HTTP ${status}`);
        if(looksLikeLoginHtml(text)) throw new Error('Published CSV needs publish-to-web');
        const items = parseOffersFromCsv(text);
        if(items.length){
          offersData = items;
          offersLoaded = true;
          UI.setDb('ok', `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${items.length}`);
          UI.setMsg('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
          return;
        }
      }catch(e){
        console.warn('Published CSV failed:', e);
      }

      // fallback
      offersData = sampleData();
      offersLoaded = true;
      UI.setDb('warn', 'âš ï¸ ÙØ´Ù„ Ø§Ù„Ø´ÙŠØª â€” ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§ØªØ§ ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
      UI.setMsg('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´ÙŠØª (ØºØ§Ù„Ø¨Ø§Ù‹ Ø§Ù„Ø´ÙŠØª ØºÙŠØ± Public/Published). ØªÙ… ØªØ´ØºÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ø¤Ù‚ØªØ§Ù‹.', 'var(--warn)');
    }

    function sampleData(){
      return [{
        barcode:'3616303321932',
        productName:'ADIDAS ICE DIVE NATURAL SPRAY 100ML',
        brand:'ADIDAS',
        discount:'20%',
        priceBefore:'48',
        save:'9.6',
        priceAfter:'38.47',
        arDescription:'Ø¨Ø®Ø§Ø® Ø£Ø¯ÙŠØ¯Ø§Ø³ Ø¢ÙŠØ³ Ø¯Ø§ÙŠÙ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ 100 Ù…Ù„',
        category:'COSMETICS',
        type:'Ø«Ø§Ø¨Øª'
      }];
    }

    // ====== OFFER STATUS ======
    function parseDateSafe(dateStr){
      if(!dateStr) return null;
      const s = String(dateStr).trim();
      if(!s || s === 'âˆ' || s.toLowerCase().includes('inf')) return null;

      let d = new Date(s);
      if(!isNaN(d.getTime())) return d;

      const parts = s.split(/[\/\-.]/);
      if(parts.length === 3){
        const p0 = parseInt(parts[0],10);
        const p1 = parseInt(parts[1],10);
        const y  = parseInt(parts[2],10);
        if(y > 1000){
          if(p0 > 12) return new Date(y, p1-1, p0);
          return new Date(y, p0-1, p1);
        }
      }
      return null;
    }

    function offerStatus(offer){
      if((offer.type||'').trim() === 'Ø«Ø§Ø¨Øª'){
        return { label:'âœ… Ø³Ø§Ø±ÙŠ', color:'#16a34a', msg:'Ø¹Ø±Ø¶ Ù…Ø³ØªÙ…Ø±' };
      }
      const today = new Date(); today.setHours(0,0,0,0);
      const start = parseDateSafe(offer.startDate);
      const end   = parseDateSafe(offer.endDate);

      if(start && start > today){
        const diff = Math.ceil((start - today)/86400000);
        return { label:'ğŸ”œ Ù„Ù… ÙŠØ¨Ø¯Ø£', color:'#64748b', msg:`Ø¨Ø¹Ø¯ ${diff} ÙŠÙˆÙ…` };
      }
      if(end && end < today){
        return { label:'âŒ Ù…Ù†ØªÙ‡ÙŠ', color:'#ef4444', msg:'Ø§Ù†ØªÙ‡Ù‰' };
      }
      if(end){
        const diff = Math.ceil((end - today)/86400000);
        if(diff <= 3) return { label:'âš¡ ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹', color:'#f59e0b', msg:`${diff} ÙŠÙˆÙ…` };
        return { label:'âœ… Ø³Ø§Ø±ÙŠ', color:'#16a34a', msg:`${diff} ÙŠÙˆÙ…` };
      }
      return { label:'âœ… Ø³Ø§Ø±ÙŠ', color:'#16a34a', msg:'Ù…Ø³ØªÙ…Ø±' };
    }

    // ====== SCANNER ======
    const Scanner = {
      html5: null,
      scanning: false,
      facing: 'environment',
      audioCtx: null,
      formatsReady: false,

      async ensureLib(){
        if(window.Html5Qrcode && window.Html5QrcodeSupportedFormats) return;
        await new Promise((resolve, reject)=>{
          const s = document.createElement('script');
          s.src = 'https://unpkg.com/html5-qrcode';
          s.onload = resolve;
          s.onerror = reject;
          document.head.appendChild(s);
        });
      },

      isMobile(){
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
          || (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
      },

      async init(){
        if(!offersLoaded) await loadOffers();
        await this.ensureLib();

        // Ø¬Ù‡Ù‘Ø² formatsToSupport (1D barcodes + QR)
        this.formats = [
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E,
          Html5QrcodeSupportedFormats.UPC_EAN_EXTENSION,
          Html5QrcodeSupportedFormats.CODE_128,
          Html5QrcodeSupportedFormats.CODE_39,
          Html5QrcodeSupportedFormats.CODE_93,
          Html5QrcodeSupportedFormats.ITF,
          Html5QrcodeSupportedFormats.CODABAR,
          Html5QrcodeSupportedFormats.PDF_417,
          Html5QrcodeSupportedFormats.DATA_MATRIX,
          Html5QrcodeSupportedFormats.QR_CODE,
          Html5QrcodeSupportedFormats.AZTEC
        ];
      },

      beep(){
        try{
          if(!this.audioCtx){
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          }
          const ctx = this.audioCtx;
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g); g.connect(ctx.destination);
          o.frequency.value = 1700;
          o.type = 'sine';
          g.gain.setValueAtTime(0.25, ctx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.12);
          o.start(ctx.currentTime);
          o.stop(ctx.currentTime + 0.12);
        }catch(e){}
      },

      findOfferByBarcode(barcode){
        const b = String(barcode||'').trim();
        // Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ØªØ±Ø¬Ø¹ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹ spaces Ø£Ùˆ \n
        return offersData.find(x => String(x.barcode||'').trim() === b);
      },

      searchByName(query){
        const q = String(query||'').toLowerCase();
        return offersData.filter(x => {
          const a = (x.productName||'').toLowerCase();
          const b = (x.arDescription||'').toLowerCase();
          const c = (x.brand||'').toLowerCase();
          const d = (x.category||'').toLowerCase();
          return a.includes(q)||b.includes(q)||c.includes(q)||d.includes(q);
        });
      },

      showScanner(mode='camera'){
        UI.open('scannerModal');

        const cameraArea = document.getElementById('cameraArea');
        const cameraActions = document.getElementById('cameraActions');
        const divider = document.getElementById('divider');
        const title = document.getElementById('scannerTitle');

        if(mode === 'search'){
          title.textContent = 'ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶';
          cameraArea.style.display = 'none';
          cameraActions.style.display = 'none';
          divider.style.display = 'none';
          setTimeout(()=>document.getElementById('manualInput')?.focus(), 150);
        }else{
          title.textContent = 'ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯';
          cameraArea.style.display = 'block';
          cameraActions.style.display = 'flex';
          divider.style.display = 'flex';
        }
      },

      async startCamera(){
        await this.init();

        this.showScanner('camera');

        // Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ØªÙ…Ù†Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ø¯ÙˆÙ† ØªÙØ§Ø¹Ù„ â€” Ù†Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø©
        UI.setCam('info','ØªØ´ØºÙŠÙ„...');

        // Desktop: Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ´ØªØºÙ„ Ø¹Ø§Ø¯ÙŠ Ù„Ùˆ Ù…ØªØ§Ø­Ø© â€” Ù…Ø§ Ù†Ù…Ù†Ø¹Ù‡Ø§
        // Ù„ÙƒÙ† Ù„Ùˆ ÙØ´Ù„ØªØŒ ÙŠØªØ­ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„ÙŠØ¯ÙˆÙŠ
        try{
          // clean previous instance
          if(this.html5){
            try{ await this.html5.stop(); }catch(e){}
            this.html5 = null;
            this.scanning = false;
          }

          // create instance with formats support
          this.html5 = new Html5Qrcode('scannerPreview', {
            formatsToSupport: this.formats,
            verbose: false
          });

          // qrbox Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù…Ø³ØªØ·ÙŠÙ„ Ø¹Ø±ÙŠØ¶) ÙˆÙŠØªÙƒÙŠÙ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø©
          const cfg = {
            fps: 12,
            aspectRatio: 1.6,
            qrbox: (viewfinderWidth, viewfinderHeight) => {
              const w = Math.min(380, Math.floor(viewfinderWidth * 0.82));
              const h = Math.min(170, Math.floor(viewfinderHeight * 0.26));
              return { width: w, height: h };
            },
            rememberLastUsedCamera: true,
            experimentalFeatures: {
              useBarCodeDetectorIfSupported: true
            }
          };

          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø®ØªÙŠØ§Ø± ÙƒØ§Ù…ÙŠØ±Ø§ Ø®Ù„ÙÙŠØ© Ø¨Ø§Ù„Ù€ deviceId (Ø£Ù‚ÙˆÙ‰ Ù…Ù† facingMode Ø£Ø­ÙŠØ§Ù†Ø§Ù‹)
          let cameraConfig = { facingMode: this.facing };

          try{
            const cams = await Html5Qrcode.getCameras();
            if(cams && cams.length){
              // ÙŠÙØ¶Ù‘Ù„ back/environment label
              const back = cams.find(c => (c.label||'').toLowerCase().includes('back'))
                        || cams.find(c => (c.label||'').toLowerCase().includes('rear'))
                        || cams.find(c => (c.label||'').toLowerCase().includes('environment'))
                        || cams[cams.length - 1]; // ØºØ§Ù„Ø¨Ø§Ù‹ Ø¢Ø®Ø± ÙƒØ§Ù…ÙŠØ±Ø§ Ù‡ÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
              if(back && back.id){
                cameraConfig = { deviceId: { exact: back.id } };
              }
            }
          }catch(e){}

          const onSuccess = (decodedText) => {
            const code = String(decodedText||'').trim();
            if(!code) return;
            this.beep();
            this.stopCamera(true);
            this.showResultFor(code);
          };

          await this.html5.start(
            cameraConfig,
            cfg,
            onSuccess,
            () => {}
          );

          this.scanning = true;
          UI.setCam('ok','âœ… ØªØ¹Ù…Ù„');
        }catch(err){
          console.error('Camera start error:', err);
          this.scanning = false;
          UI.setCam('err','âŒ ÙØ´Ù„');
          // ÙŠÙØªØ­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙŠØ¯ÙˆÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          this.showScanner('search');

          const msg = (err && err.name) ? err.name : (err && err.message ? err.message : 'Unknown');
          UI.setMsg(`ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ${msg}. (Ø¥Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø§Ø¶ØºØ· Ø²Ø± "ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¢Ù†")`, 'var(--warn)');
        }
      },

      async stopCamera(keepModal=false){
        try{
          if(this.html5 && this.scanning){
            await this.html5.stop();
          }
        }catch(e){}
        this.scanning = false;
        if(!keepModal){
          UI.close('scannerModal');
        }
      },

      async switchCamera(){
        // ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† user/environment
        this.facing = (this.facing === 'environment') ? 'user' : 'environment';
        if(!this.html5){
          await this.startCamera();
          return;
        }
        try{
          await this.stopCamera(true);
        }catch(e){}
        await this.startCamera();
      },

      manualSearch(){
        const input = document.getElementById('manualInput');
        const q = (input?.value||'').trim();
        if(!q) return;

        // ÙˆÙ‚Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ùˆ Ø´ØºØ§Ù„Ø©
        this.stopCamera(true);

        // Ø¥Ø°Ø§ Ø¨Ø§Ø±ÙƒÙˆØ¯
        const exact = this.findOfferByBarcode(q);
        if(exact){
          UI.close('scannerModal');
          this.showOffer(exact, q);
          input.value='';
          return;
        }

        // Ø¨Ø­Ø« Ù†ØµÙŠ
        const list = this.searchByName(q);
        if(list.length === 1){
          UI.close('scannerModal');
          this.showOffer(list[0], list[0].barcode);
        }else if(list.length > 1){
          UI.close('scannerModal');
          this.showMultiple(list);
        }else{
          UI.close('scannerModal');
          this.showNotFound(q);
        }
        input.value='';
      },

      showResultFor(barcode){
        const offer = this.findOfferByBarcode(barcode);
        if(offer) this.showOffer(offer, barcode);
        else this.showNotFound(barcode);
      },

      showOffer(offer, barcode){
        const st = offerStatus(offer);
        document.getElementById('resultTitle').textContent = 'ğŸ‰ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶!';
        const body = document.getElementById('resultBody');
        body.innerHTML = `
          <div class="offer-card">
            <div class="banner" style="background:${st.color}">
              <span>${st.label}</span>
              <span>|</span>
              <span>${st.msg}</span>
            </div>

            <div class="tag">${(offer.brand||'').trim() || 'â€”'}</div>
            <div style="font-weight:900;font-size:14px;color:#fff;line-height:1.45">
              ${(offer.productName||'').trim() || 'â€”'}
            </div>
            <div style="margin-top:6px;color:var(--muted);font-size:12px;line-height:1.5">
              ${(offer.arDescription||'').trim() || ''}
            </div>

            <div class="kv">
              <span>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</span>
              <span style="font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:900">${barcode}</span>
            </div>

            <div class="kv">
              <span>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ</span>
              <span class="strike">${offer.priceBefore || 'â€”'} SAR</span>
            </div>

            <div class="kv">
              <span>Ø§Ù„Ø®ØµÙ…</span>
              <span style="background:#ef4444;color:#fff;padding:2px 10px;border-radius:999px;font-weight:900;font-size:12px">
                ${offer.discount || 'â€”'}
              </span>
            </div>

            <div class="kv" style="align-items:baseline">
              <span>Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶</span>
              <span class="big">${offer.priceAfter || 'â€”'} SAR</span>
            </div>

            <div class="kv">
              <span>Ø§Ù„ØªØµÙ†ÙŠÙ</span>
              <span>${offer.category || 'â€”'}</span>
            </div>
          </div>
        `;
        UI.open('resultModal');
      },

      showNotFound(barcode){
        document.getElementById('resultTitle').textContent = 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶';
        const body = document.getElementById('resultBody');
        body.innerHTML = `
          <div class="offer-card">
            <div class="banner" style="background:#ef4444">âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>
            <div class="kv">
              <span>Ø§Ù„Ù…Ø¯Ø®Ù„</span>
              <span style="font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:900">${barcode}</span>
            </div>
            <div style="margin-top:10px;color:var(--muted);font-size:12px;line-height:1.6;text-align:center">
              Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ù‡ Ø¹Ø±Ø¶ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
            </div>
          </div>
        `;
        UI.open('resultModal');
      },

      showMultiple(list){
        document.getElementById('resultTitle').textContent = `ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${list.length} Ù†ØªØ§Ø¦Ø¬`;
        const body = document.getElementById('resultBody');
        body.innerHTML = `
          <div class="results-list">
            ${list.map((x,i)=>`
              <div class="res-item" data-i="${i}">
                <div class="b">${x.brand || ''}</div>
                <div class="n">${x.productName || ''}</div>
                <div class="p">
                  ${x.priceAfter || 'â€”'} SAR
                  <span class="mini">${x.priceBefore || ''} SAR</span>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        UI.open('resultModal');

        // click handlers
        setTimeout(()=>{
          document.querySelectorAll('.res-item').forEach(el=>{
            el.addEventListener('click', ()=>{
              const i = parseInt(el.getAttribute('data-i'),10);
              const offer = list[i];
              if(offer) this.showOffer(offer, offer.barcode);
            });
          });
        }, 0);
      }
    };

    // ====== BIND EVENTS ======
    document.getElementById('openScannerBtn').addEventListener('click', ()=>Scanner.startCamera());
    document.getElementById('openSearchBtn').addEventListener('click', async ()=>{
      if(!offersLoaded) await loadOffers();
      Scanner.showScanner('search');
    });

    document.getElementById('closeScanner').addEventListener('click', ()=>Scanner.stopCamera(false));
    document.getElementById('stopScan').addEventListener('click', ()=>Scanner.stopCamera(false));
    document.getElementById('switchCam').addEventListener('click', ()=>Scanner.switchCamera());

    document.getElementById('manualBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      Scanner.manualSearch();
    });

    document.getElementById('manualInput').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        Scanner.manualSearch();
      }
    });

    document.getElementById('closeResult').addEventListener('click', ()=>UI.close('resultModal'));
    document.getElementById('closeResult2').addEventListener('click', ()=>UI.close('resultModal'));
    document.getElementById('scanAgain').addEventListener('click', async ()=>{
      UI.close('resultModal');
      await Scanner.startCamera();
    });

    // Ø§ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
    document.getElementById('scannerModal').addEventListener('click', (e)=>{
      if(e.target.id === 'scannerModal') Scanner.stopCamera(false);
    });
    document.getElementById('resultModal').addEventListener('click', (e)=>{
      if(e.target.id === 'resultModal') UI.close('resultModal');
    });

    // ====== AUTO START ======
    document.addEventListener('DOMContentLoaded', async ()=>{
      UI.setCam('info','ØªØ´ØºÙŠÙ„...');
      await loadOffers();
      // ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
      await Scanner.startCamera();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rass 1 Hub - Scanner</title>
  <link rel="icon" href="logo.png" type="image/png">

  <style>
    :root{
      --primary:#561C2C;
      --primary-light:#7a2840;
      --danger:#ef4444;
      --warn:#f59e0b;
      --info:#3b82f6;
      --bg1:#0b1220;
      --bg2:#020617;
      --card:rgba(15,23,42,0.9);
      --border:rgba(148,163,184,0.25);
      --text:#e5e7eb;
      --muted:#9ca3af;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      min-height:100vh;
      background:radial-gradient(circle at top, var(--bg1) 0%, var(--bg2) 55%, #000 100%);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{max-width:560px;width:100%}
    .top{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:12px}
    .top img{height:64px;filter:drop-shadow(0 2px 6px rgba(0,0,0,0.45))}
    .title{text-align:center;margin-bottom:14px}
    .title h1{font-size:18px;color:#f9fafb;margin-bottom:5px}
    .title p{font-size:12px;color:var(--muted);line-height:1.5}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 18px 50px rgba(0,0,0,0.7);
    }

    .status{
      margin-top:10px;
      background:rgba(2,6,23,0.6);
      border:1px solid rgba(148,163,184,0.25);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .status-line{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-size:12px;color:var(--muted);
    }
    .pill{
      font-size:11px;font-weight:900;letter-spacing:.2px;
      padding:4px 10px;border-radius:999px;color:#fff;white-space:nowrap;
    }
    .pill.ok{background:#16a34a}
    .pill.warn{background:#f59e0b}
    .pill.err{background:#ef4444}
    .pill.info{background:#3b82f6}

    .miniBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.22);
      background:rgba(2,6,23,0.55);
      color:var(--muted);
      font-size:11px;
      line-height:1.6;
      white-space:pre-wrap;
      max-height:220px;
      overflow:auto;
    }

    /* Modal */
    .modal{
      position:fixed;inset:0;
      background:rgba(2,6,23,0.92);
      backdrop-filter:blur(7px);
      display:flex;align-items:center;justify-content:center;
      opacity:0;visibility:hidden;
      transition:.25s;
      z-index:9999;
      padding:14px;
    }
    .modal.active{opacity:1;visibility:visible}
    .modal-box{
      width:100%;max-width:650px;
      background:radial-gradient(circle at top, #111827 0%, #020617 55%, #000 100%);
      border:1px solid rgba(148,163,184,0.35);
      border-radius:18px;
      padding:14px;
      box-shadow:0 25px 70px rgba(0,0,0,0.85);
    }
    .modal-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .modal-head h2{font-size:15px}
    .x{
      background:transparent;border:none;color:var(--muted);
      font-size:22px;cursor:pointer;line-height:1;
      padding:4px 8px;border-radius:10px;
    }
    .x:hover{color:#fff;background:rgba(148,163,184,0.15)}
    .preview{
      width:100%;
      aspect-ratio:16/10;
      border-radius:16px;
      overflow:hidden;
      background:#000;
      position:relative;
      border:1px solid rgba(148,163,184,0.25);
    }
    .preview::after{
      content:'';
      position:absolute;
      left:8%;
      right:8%;
      top:38%;
      bottom:38%;
      border-radius:14px;
      border:2px dashed rgba(248,250,252,0.55);
      box-shadow:0 0 0 999px rgba(0,0,0,0.35);
      pointer-events:none;
    }
    .hint{margin-top:8px;text-align:center;color:var(--muted);font-size:12px;line-height:1.5}

    .manual{
      margin-top:12px;
      background:rgba(2,6,23,0.55);
      border:1px solid rgba(148,163,184,0.25);
      border-radius:16px;
      padding:10px;
    }
    .divider{
      display:flex;align-items:center;justify-content:center;gap:10px;
      color:var(--muted);font-size:11px;margin-bottom:8px;
    }
    .divider:before,.divider:after{
      content:'';
      flex:1;height:1px;
      background:linear-gradient(to left, transparent, rgba(148,163,184,0.7));
    }
    .divider:after{background:linear-gradient(to right, transparent, rgba(148,163,184,0.7))}
    .manual-row{display:flex;gap:8px;flex-wrap:wrap}
    .manual-row input{
      flex:1;min-width:180px;
      padding:11px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background:rgba(15,23,42,0.9);
      color:var(--text);
      font-size:13px;
      outline:none;
    }
    .manual-row input:focus{
      border-color:rgba(122,40,64,0.9);
      box-shadow:0 0 0 2px rgba(122,40,64,0.35);
    }

    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{
      border:none;border-radius:999px;padding:12px 16px;
      cursor:pointer;font-weight:800;font-size:13px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      transition:.25s;flex:1;min-width:160px;
      user-select:none;
    }
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(148,163,184,0.45)}
    .btn.danger{background:linear-gradient(135deg,#b91c1c,#ef4444);color:#fff}
    .btn.info{background:linear-gradient(135deg,#1d4ed8,#3b82f6);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Result */
    .result-body{margin-top:10px}
    .offer-card{
      background:linear-gradient(145deg,rgba(15,23,42,0.95),rgba(15,23,42,0.6));
      border:1px solid rgba(148,163,184,0.3);
      border-radius:16px;
      padding:12px;
    }
    .banner{
      padding:8px 10px;border-radius:12px;color:#fff;
      display:flex;justify-content:center;gap:10px;align-items:center;
      font-weight:900;font-size:12px;margin-bottom:10px;
    }
    .kv{
      display:flex;justify-content:space-between;gap:10px;
      padding:7px 8px;border-radius:12px;
      background:rgba(2,6,23,0.55);
      border:1px solid rgba(148,163,184,0.22);
      margin-top:8px;
      font-size:13px;
    }
    .kv span:first-child{color:var(--muted)}
    .big{font-size:18px;font-weight:1000;color:#22c55e;}
    .strike{color:#f87171;text-decoration:line-through;font-weight:900}
    .tag{
      display:inline-block;
      padding:3px 10px;border-radius:999px;
      background:#4f46e5;color:#fff;
      font-size:11px;font-weight:1000;
      margin-bottom:8px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <img src="logo.png" alt="Rass 1 Hub" onerror="this.style.display='none'">
    </div>

    <div class="title">
      <h1>Rass 1 Hub â€” Scanner</h1>
      <p>ÙŠÙØªØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙŠØ³ØªØ®Ø¯Ù… ÙƒÙ„ Ø§Ù„Ø´ÙŠØªØ§Øª Ø¨Ø¯ÙˆÙ† Ø§Ø®ØªÙŠØ§Ø±</p>
    </div>

    <div class="card">
      <div class="status">
        <div class="status-line">
          <span>Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶</span>
          <span id="dbPill" class="pill info">... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</span>
        </div>
        <div class="status-line">
          <span>Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</span>
          <span id="camPill" class="pill info">Ø¬Ø§Ù‡Ø²</span>
        </div>
      </div>
      <div class="miniBox" id="debugBox">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„...</div>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div id="scannerModal" class="modal">
    <div class="modal-box">
      <div class="modal-head">
        <h2 id="scannerTitle">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h2>
        <button class="x" id="closeScanner">Ã—</button>
      </div>

      <div id="cameraArea">
        <div id="scannerPreview" class="preview"></div>
        <div class="hint">Ù‚Ø±Ù‘Ø¨ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„</div>
      </div>

      <div class="manual">
        <div class="divider">Ø£Ùˆ Ø§Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠØ§Ù‹</div>
        <div class="manual-row">
          <input id="manualInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." />
          <button id="manualBtn" class="btn info" style="min-width:120px;flex:0">Ø¨Ø­Ø«</button>
        </div>
      </div>

      <div class="actions" id="cameraActions">
        <button id="switchCam" class="btn ghost">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button id="stopScan" class="btn danger">Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>
    </div>
  </div>

  <!-- Result Modal -->
  <div id="resultModal" class="modal">
    <div class="modal-box">
      <div class="modal-head">
        <h2 id="resultTitle">Ø§Ù„Ù†ØªÙŠØ¬Ø©</h2>
        <button class="x" id="closeResult">Ã—</button>
      </div>
      <div class="result-body" id="resultBody"></div>
      <div class="actions">
        <button id="scanAgain" class="btn primary">ğŸ“· Ù…Ø³Ø­ Ø¬Ø¯ÙŠØ¯</button>
        <button id="closeResult2" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // MULTI SHEETS (ALL AUTO)
    // =========================
    // Ø¶Ø¹ Ù‡Ù†Ø§ ÙƒÙ„ Ø§Ù„Ø´ÙŠØªØ§Øª Ø§Ù„Ù„ÙŠ ØªØ¨ØºØ§Ù‡Ø§ (sheetId + gid)
    const SHEETS = [
      { name: 'Offers Base (old)', sheetId: '1-_6mN6DpmuUbpgy3q3h-RXRjPepfhhcdIx2K3oybCzw', gid: 0 },
      { name: 'update promotion 27', sheetId: '1xd6gpkII3lxnr1h1mbGTYiomR3Q1HpAZltHD8nDXCI0', gid: 0 }
    ];

    let offersData = [];
    let offersLoaded = false;

    const UI = {
      dbPill: () => document.getElementById('dbPill'),
      camPill: () => document.getElementById('camPill'),
      debug: () => document.getElementById('debugBox'),
      setDb(status, text){
        const pill = UI.dbPill();
        pill.className = 'pill ' + status;
        pill.textContent = text;
      },
      setCam(status, text){
        const pill = UI.camPill();
        pill.className = 'pill ' + status;
        pill.textContent = text;
      },
      log(msg){
        const el = UI.debug();
        const now = new Date().toLocaleTimeString('en-GB');
        el.textContent = `[${now}] ${msg}\n\n` + el.textContent;
      },
      open(id){ document.getElementById(id)?.classList.add('active'); },
      close(id){ document.getElementById(id)?.classList.remove('active'); },
    };

    // =========================
    // BARCODE NORMALIZATION
    // =========================
    function digitsOnly(s){ return String(s || '').replace(/\D/g, ''); }

    function sciToIntString(s){
      const str = String(s).trim();
      const m = str.match(/^([+-]?\d+)(?:\.(\d+))?[eE]([+-]?\d+)$/);
      if(!m) return str;
      const intPart = m[1].replace('+','').replace('-','');
      const fracPart = m[2] || '';
      const exp = parseInt(m[3], 10);
      const sign = str.startsWith('-') ? '-' : '';
      const digits = intPart + fracPart;
      const fracLen = fracPart.length;
      const shift = exp - fracLen;
      if(shift >= 0) return sign + digits + '0'.repeat(shift);
      const cut = digits.length + shift;
      if(cut <= 0) return sign + '0';
      return sign + digits.slice(0, cut);
    }

    function normalizeBarcode(raw){
      if(raw === null || raw === undefined) return '';
      let s = String(raw).trim();
      if(/[eE]/.test(s) && /^\s*[+-]?\d+(\.\d+)?[eE][+-]?\d+\s*$/.test(s)){
        s = sciToIntString(s);
      }
      s = s.replace(/\.0+$/,'');
      return digitsOnly(s);
    }

    // =========================
    // GVIZ PAGINATED LOADER
    // =========================
    function gvizUrl(sheetId, gid, limit, offset){
      const tq = encodeURIComponent(`select * limit ${limit} offset ${offset}`);
      return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}&tq=${tq}`;
    }

    async function fetchText(url){
      const r = await fetch(url, { cache: 'no-store' });
      const t = await r.text();
      return { ok: r.ok, status: r.status, text: t };
    }

    function looksLikeLoginHtml(t){
      const s = (t||'').toLowerCase();
      return s.includes('<!doctype html') && (s.includes('accounts.google.com') || s.includes('signin') || s.includes('service-login'));
    }

    function parseGvizResponse(gvizText){
      const match = gvizText.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/);
      if(!match || !match[1]) throw new Error('GVIZ format mismatch');
      const data = JSON.parse(match[1]);
      const rows = (data?.table?.rows || []);
      return { rows };
    }

    function cellText(cell){
      if(!cell) return '';
      if(cell.f !== null && cell.f !== undefined && String(cell.f).trim() !== '') return String(cell.f).trim();
      if(cell.v !== null && cell.v !== undefined) return String(cell.v).trim();
      return '';
    }

    function detectBarcodeColumn(rows){
      if(!rows || !rows.length) return 0;
      const colCount = Math.max(...rows.map(r => (r.c || []).length), 0);
      const score = new Array(colCount).fill(0);
      const sampleN = Math.min(200, rows.length);
      for(let i=0;i<sampleN;i++){
        const c = rows[i].c || [];
        for(let j=0;j<colCount;j++){
          const raw = cellText(c[j]);
          const norm = normalizeBarcode(raw);
          if(norm.length >= 6) score[j] += 1;
        }
      }
      let best = 0;
      for(let j=1;j<score.length;j++){
        if(score[j] > score[best]) best = j;
      }
      return best;
    }

    function detectTextColumn(rows, avoidIndex){
      const colCount = Math.max(...rows.map(r => (r.c || []).length), 0);
      const score = new Array(colCount).fill(0);
      const sampleN = Math.min(200, rows.length);
      for(let i=0;i<sampleN;i++){
        const c = rows[i].c || [];
        for(let j=0;j<colCount;j++){
          if(j === avoidIndex) continue;
          const v = cellText(c[j]);
          if(v && v.length >= 3 && !/^\d+(\.\d+)?$/.test(v)) score[j] += 1;
        }
      }
      let best = avoidIndex === 0 ? 1 : 0;
      for(let j=0;j<score.length;j++){
        if(j === avoidIndex) continue;
        if(score[j] > score[best]) best = j;
      }
      return best;
    }

    function rowsToOffers(rows, sourceName){
      if(!rows?.length) return [];
      const barcodeCol = detectBarcodeColumn(rows);
      const nameCol = detectTextColumn(rows, barcodeCol);

      const items = [];
      for(const row of rows){
        const c = row.c || [];
        const rawBarcode = cellText(c[barcodeCol]);
        const barcode = normalizeBarcode(rawBarcode);
        if(!barcode) continue;

        items.push({
          barcode,
          productName: cellText(c[nameCol]),
          brand: cellText(c[2]) || '',
          discount: cellText(c[3]) || '',
          priceBefore: cellText(c[4]) || '',
          save: cellText(c[5]) || '',
          priceAfter: cellText(c[6]) || '',
          startDate: cellText(c[8]) || '',
          endDate: cellText(c[9]) || '',
          arDescription: cellText(c[10]) || '',
          type: cellText(c[11]) || '',
          category: cellText(c[12]) || '',
          _source: sourceName
        });
      }
      return items;
    }

    async function loadOneSheetPaged(sheet){
      const limit = 500;
      let offset = 0;
      let page = 1;
      let allRows = [];

      while(true){
        const url = gvizUrl(sheet.sheetId, sheet.gid, limit, offset);
        UI.log(`ğŸ“„ (${sheet.name}) Ø¯ÙØ¹Ø© #${page} offset=${offset}`);

        const { ok, status, text } = await fetchText(url);
        if(!ok) throw new Error(`${sheet.name}: GVIZ HTTP ${status}`);
        if(looksLikeLoginHtml(text)) throw new Error(`${sheet.name}: Ø§Ù„Ø´ÙŠØª ÙŠØ­ØªØ§Ø¬ Public`);

        const { rows } = parseGvizResponse(text);
        if(!rows || rows.length === 0){
          UI.log(`âœ… (${sheet.name}) Ø§Ù†ØªÙ‡Ù‰`);
          break;
        }

        allRows = allRows.concat(rows);

        if(rows.length < limit){
          UI.log(`âœ… (${sheet.name}) Ø¢Ø®Ø± Ø¯ÙØ¹Ø©`);
          break;
        }

        offset += limit;
        page += 1;
        if(page > 60) break;
      }

      const offers = rowsToOffers(allRows, sheet.name);
      UI.log(`ğŸ” (${sheet.name}) rows=${allRows.length} -> offers=${offers.length}`);
      return offers;
    }

    async function loadAllSheets(){
      UI.setDb('info','... ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´ÙŠØªØ§Øª');
      UI.log('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø´ÙŠØªØ§Øª...');

      const all = [];
      for(const s of SHEETS){
        try{
          const offers = await loadOneSheetPaged(s);
          all.push(...offers);
        }catch(e){
          UI.log('âŒ Ø®Ø·Ø£: ' + (e?.message || e));
        }
      }

      // Deduplicate by barcode (keep first)
      const seen = new Set();
      const deduped = [];
      for(const it of all){
        if(!it.barcode) continue;
        if(seen.has(it.barcode)) continue;
        seen.add(it.barcode);
        deduped.push(it);
      }

      offersData = deduped;
      offersLoaded = true;

      UI.setDb('ok', `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${offersData.length}`);
      UI.log(`ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ù…Ø¬: ${all.length} | Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±: ${offersData.length}`);
      if(offersData.length < 1000){
        UI.setDb('warn', `âš ï¸ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${offersData.length} ÙÙ‚Ø·`);
        UI.log('âš ï¸ Ø§Ù„Ø¹Ø¯Ø¯ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ØºØ§Ù„Ø¨Ø§Ù‹ Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª ÙƒØ«ÙŠØ±Ø© Ù…Ø®Ø²Ù†Ø© ÙƒÙ€ Number Ø£Ùˆ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù…Ø®ØªÙ„Ù Ø¬Ø¯Ø§Ù‹.');
      }
    }

    // =========================
    // OFFER STATUS
    // =========================
    function parseDateSafe(dateStr){
      if(!dateStr) return null;
      const s = String(dateStr).trim();
      if(!s || s === 'âˆ' || s.toLowerCase().includes('inf')) return null;
      const d = new Date(s);
      if(!isNaN(d.getTime())) return d;
      const parts = s.split(/[\/\-.]/);
      if(parts.length === 3){
        const p0 = parseInt(parts[0],10);
        const p1 = parseInt(parts[1],10);
        const y  = parseInt(parts[2],10);
        if(y > 1000){
          if(p0 > 12) return new Date(y, p1-1, p0);
          return new Date(y, p0-1, p1);
        }
      }
      return null;
    }

    function offerStatus(offer){
      if((offer.type||'').trim() === 'Ø«Ø§Ø¨Øª'){
        return { label:'âœ… Ø³Ø§Ø±ÙŠ', color:'#16a34a', msg:'Ø¹Ø±Ø¶ Ù…Ø³ØªÙ…Ø±' };
      }
      const today = new Date(); today.setHours(0,0,0,0);
      const start = parseDateSafe(offer.startDate);
      const end   = parseDateSafe(offer.endDate);

      if(start && start > today){
        const diff = Math.ceil((start - today)/86400000);
        return { label:'ğŸ”œ Ù„Ù… ÙŠØ¨Ø¯Ø£', color:'#64748b', msg:`Ø¨Ø¹Ø¯ ${diff} ÙŠÙˆÙ…` };
      }
      if(end && end < today){
        return { label:'âŒ Ù…Ù†ØªÙ‡ÙŠ', color:'#ef4444', msg:'Ø§Ù†ØªÙ‡Ù‰' };
      }
      if(end){
        const diff = Math.ceil((end - today)/86400000);
        if(diff <= 3) return { label:'âš¡ ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹', color:'#f59e0b', msg:`${diff} ÙŠÙˆÙ…` };
        return { label:'âœ… Ø³Ø§Ø±ÙŠ', color:'#16a34a', msg:`${diff} ÙŠÙˆÙ…` };
      }
      return { label:'âœ… Ø³Ø§Ø±ÙŠ', color:'#16a34a', msg:'Ù…Ø³ØªÙ…Ø±' };
    }

    // =========================
    // SCANNER
    // =========================
    const Scanner = {
      html5: null,
      scanning: false,
      facing: 'environment',
      audioCtx: null,
      formats: null,

      async ensureLib(){
        if(window.Html5Qrcode && window.Html5QrcodeSupportedFormats) return;
        UI.log('ØªØ­Ù…ÙŠÙ„ html5-qrcode...');
        await new Promise((resolve, reject)=>{
          const s = document.createElement('script');
          s.src = 'https://unpkg.com/html5-qrcode';
          s.onload = resolve;
          s.onerror = reject;
          document.head.appendChild(s);
        });
        UI.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©');
      },

      async init(){
        if(!offersLoaded) await loadAllSheets();
        await this.ensureLib();

        this.formats = [
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E,
          Html5QrcodeSupportedFormats.UPC_EAN_EXTENSION,
          Html5QrcodeSupportedFormats.CODE_128,
          Html5QrcodeSupportedFormats.CODE_39,
          Html5QrcodeSupportedFormats.ITF,
          Html5QrcodeSupportedFormats.CODABAR,
          Html5QrcodeSupportedFormats.PDF_417,
          Html5QrcodeSupportedFormats.DATA_MATRIX,
          Html5QrcodeSupportedFormats.QR_CODE
        ];
      },

      beep(){
        try{
          if(!this.audioCtx){
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          }
          const ctx = this.audioCtx;
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g); g.connect(ctx.destination);
          o.frequency.value = 1700;
          o.type = 'sine';
          g.gain.setValueAtTime(0.25, ctx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.12);
          o.start(ctx.currentTime);
          o.stop(ctx.currentTime + 0.12);
        }catch(e){}
      },

      showScanner(){
        UI.open('scannerModal');
        setTimeout(()=>document.getElementById('manualInput')?.focus(), 250);
      },

      findOffer(barcodeRaw){
        const scanned = normalizeBarcode(barcodeRaw);
        if(!scanned) return null;
        return offersData.find(x => x.barcode === scanned) || null;
      },

      searchByName(query){
        const q = String(query||'').toLowerCase();
        return offersData.filter(x => {
          const a = (x.productName||'').toLowerCase();
          const b = (x.arDescription||'').toLowerCase();
          const c = (x.brand||'').toLowerCase();
          const d = (x.category||'').toLowerCase();
          return a.includes(q)||b.includes(q)||c.includes(q)||d.includes(q);
        });
      },

      async startCamera(){
        await this.init();
        this.showScanner();

        UI.setCam('info','ØªØ´ØºÙŠÙ„...');
        UI.log('ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...');

        try{
          if(this.html5){
            try{ await this.html5.stop(); }catch(e){}
            this.html5 = null;
            this.scanning = false;
          }

          this.html5 = new Html5Qrcode('scannerPreview', {
            formatsToSupport: this.formats,
            verbose: false
          });

          const cfg = {
            fps: 20,
            disableFlip: true,
            aspectRatio: 1.6,
            qrbox: (vw, vh) => {
              const w = Math.min(420, Math.floor(vw * 0.88));
              const h = Math.min(190, Math.floor(vh * 0.28));
              return { width: w, height: h };
            },
            rememberLastUsedCamera: true,
            experimentalFeatures: { useBarCodeDetectorIfSupported: true },
            showTorchButtonIfSupported: true,
            showZoomSliderIfSupported: true,
            defaultZoomValueIfSupported: 2
          };

          let cameraConfig = { facingMode: this.facing };
          try{
            const cams = await Html5Qrcode.getCameras();
            if(cams && cams.length){
              const back = cams.find(c => (c.label||'').toLowerCase().includes('back'))
                        || cams.find(c => (c.label||'').toLowerCase().includes('rear'))
                        || cams.find(c => (c.label||'').toLowerCase().includes('environment'))
                        || cams[cams.length - 1];
              if(back && back.id){
                cameraConfig = { deviceId: { exact: back.id } };
              }
            }
          }catch(e){}

          const onSuccess = (decodedText) => {
            const raw = String(decodedText||'').trim();
            const norm = normalizeBarcode(raw);
            if(!norm || norm.length < 6) return;

            UI.log(`ğŸ“· Ù…Ø³Ø­: raw="${raw}" -> norm="${norm}"`);
            this.beep();
            this.stopCamera(true);
            this.showResult(norm);
          };

          await this.html5.start(cameraConfig, cfg, onSuccess, () => {});
          this.scanning = true;
          UI.setCam('ok','âœ… ØªØ¹Ù…Ù„');
          UI.log('âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„');
        }catch(err){
          console.error(err);
          this.scanning = false;
          UI.setCam('err','âŒ ÙØ´Ù„');
          UI.log('âŒ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + (err?.message || err));
        }
      },

      async stopCamera(closeModal=false){
        try{
          if(this.html5 && this.scanning){
            await this.html5.stop();
          }
        }catch(e){}
        this.scanning = false;
        if(closeModal){
          UI.close('scannerModal');
        }
      },

      async switchCamera(){
        this.facing = (this.facing === 'environment') ? 'user' : 'environment';
        UI.log(`ğŸ”„ ØªØ¨Ø¯ÙŠÙ„: ${this.facing}`);
        await this.stopCamera(false);
        await this.startCamera();
      },

      manualSearch(){
        const input = document.getElementById('manualInput');
        const q = (input?.value||'').trim();
        if(!q) return;

        const offer = this.findOffer(q);
        if(offer){
          this.showOffer(offer, normalizeBarcode(q));
          input.value='';
          return;
        }

        const list = this.searchByName(q);
        if(list.length === 1){
          this.showOffer(list[0], list[0].barcode);
        }else if(list.length > 1){
          // Ù„Ø£Ø¬Ù„ Ø§Ù„Ø¨Ø³Ø§Ø·Ø©: Ø£ÙˆÙ„ Ù†ØªÙŠØ¬Ø©
          this.showOffer(list[0], list[0].barcode);
        }else{
          this.showNotFound(q);
        }
        input.value='';
      },

      showResult(barcodeNorm){
        const offer = offersData.find(x => x.barcode === barcodeNorm);
        if(offer) this.showOffer(offer, barcodeNorm);
        else this.showNotFound(barcodeNorm);
      },

      showOffer(offer, barcode){
        const st = offerStatus(offer);
        document.getElementById('resultTitle').textContent = 'ğŸ‰ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶!';
        const body = document.getElementById('resultBody');
        body.innerHTML = `
          <div class="offer-card">
            <div class="banner" style="background:${st.color}">
              <span>${st.label}</span><span>|</span><span>${st.msg}</span>
            </div>

            <div class="tag">${(offer.brand||'').trim() || 'â€”'}</div>
            <div style="font-weight:1000;font-size:14px;color:#fff;line-height:1.45">
              ${(offer.productName||'').trim() || 'â€”'}
            </div>
            <div style="margin-top:6px;color:var(--muted);font-size:12px;line-height:1.5">
              ${(offer.arDescription||'').trim() || ''}
            </div>

            <div class="kv">
              <span>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</span>
              <span style="font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:1000">${barcode}</span>
            </div>

            <div class="kv">
              <span>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ</span>
              <span class="strike">${offer.priceBefore || 'â€”'} SAR</span>
            </div>

            <div class="kv">
              <span>Ø§Ù„Ø®ØµÙ…</span>
              <span style="background:#ef4444;color:#fff;padding:2px 10px;border-radius:999px;font-weight:1000;font-size:12px">
                ${offer.discount || 'â€”'}
              </span>
            </div>

            <div class="kv" style="align-items:baseline">
              <span>Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶</span>
              <span class="big">${offer.priceAfter || 'â€”'} SAR</span>
            </div>

            <div class="kv">
              <span>Ø§Ù„Ù…ØµØ¯Ø±</span>
              <span>${offer._source || 'â€”'}</span>
            </div>
          </div>
        `;
        UI.open('resultModal');
      },

      showNotFound(barcode){
        document.getElementById('resultTitle').textContent = 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶';
        const body = document.getElementById('resultBody');
        body.innerHTML = `
          <div class="offer-card">
            <div class="banner" style="background:#ef4444">âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>
            <div class="kv">
              <span>Ø§Ù„Ù…Ø¯Ø®Ù„</span>
              <span style="font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:1000">${barcode}</span>
            </div>
            <div style="margin-top:10px;color:var(--muted);font-size:12px;line-height:1.6;text-align:center">
              Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ù‡ Ø¹Ø±Ø¶ Ø­Ø§Ù„ÙŠØ§Ù‹.
            </div>
          </div>
        `;
        UI.open('resultModal');
      }
    };

    // =========================
    // EVENTS
    // =========================
    document.getElementById('closeScanner').addEventListener('click', ()=>{ Scanner.stopCamera(true); });
    document.getElementById('stopScan').addEventListener('click', ()=>{ Scanner.stopCamera(true); });
    document.getElementById('switchCam').addEventListener('click', ()=>Scanner.switchCamera());
    document.getElementById('manualBtn').addEventListener('click', (e)=>{ e.preventDefault(); Scanner.manualSearch(); });
    document.getElementById('manualInput').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); Scanner.manualSearch(); }
    });

    document.getElementById('closeResult').addEventListener('click', ()=>UI.close('resultModal'));
    document.getElementById('closeResult2').addEventListener('click', ()=>UI.close('resultModal'));
    document.getElementById('scanAgain').addEventListener('click', async ()=>{
      UI.close('resultModal');
      await Scanner.startCamera();
    });

    document.getElementById('scannerModal').addEventListener('click', (e)=>{
      if(e.target.id === 'scannerModal') Scanner.stopCamera(true);
    });
    document.getElementById('resultModal').addEventListener('click', (e)=>{
      if(e.target.id === 'resultModal') UI.close('resultModal');
    });

    // =========================
    // AUTO START (NO CHOOSING)
    // =========================
    document.addEventListener('DOMContentLoaded', async ()=>{
      try{
        UI.log('Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø©...');
        await loadAllSheets();
        await Scanner.startCamera();   // ÙŠÙØªØ­ Ø¹Ù„Ù‰ Ø·ÙˆÙ„
      }catch(e){
        UI.setDb('err','âŒ ÙØ´Ù„');
        UI.setCam('warn','âš ï¸');
        UI.log('Ø®Ø·Ø£: ' + (e?.message || e));
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rass 1 Hub - Scanner</title>

    <!-- Favicon (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù†ÙØ³ Ø­Ù‚ Ø§Ù„Ù‡Ø¨) -->
    <link rel="icon" href="logo.png" type="image/png">

    <style>
        :root {
            --primary:#561C2C;
            --primary-light:#7a2840;
            --accent:#8DC63F;
            --accent-dark:#6fa329;
            --danger:#e74c3c;
            --gray:#666;
            --bg:#0f172a;
        }

        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            min-height:100vh;
            background:radial-gradient(circle at top,#1f2937 0%,#020617 55%,#000 100%);
            color:#e5e7eb;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:20px;
        }

        .wrapper{
            max-width:420px;
            width:100%;
        }

        .logo{
            text-align:center;
            margin-bottom:12px;
        }
        .logo img{
            height:70px;
            filter:drop-shadow(0 2px 6px rgba(0,0,0,0.4));
        }
        .title{
            text-align:center;
            margin-bottom:18px;
        }
        .title h1{
            font-size:20px;
            color:#f9fafb;
            margin-bottom:4px;
        }
        .title p{
            font-size:13px;
            color:#9ca3af;
        }

        .card{
            background:rgba(15,23,42,0.9);
            border-radius:16px;
            padding:18px 18px 20px;
            box-shadow:0 18px 45px rgba(0,0,0,0.6);
            border:1px solid rgba(148,163,184,0.25);
        }

        .main-actions{
            display:flex;
            flex-direction:column;
            gap:10px;
            margin-bottom:10px;
        }

        .btn{
            width:100%;
            border:none;
            border-radius:999px;
            padding:12px 18px;
            font-weight:600;
            font-size:14px;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            transition:.25s;
        }
        .btn-primary{
            background:linear-gradient(135deg,var(--primary),var(--primary-light));
            color:#fff;
        }
        .btn-primary:hover{
            transform:translateY(-1px);
            box-shadow:0 6px 18px rgba(86,28,44,0.6);
        }
        .btn-outline{
            background:transparent;
            color:#e5e7eb;
            border:1px solid rgba(148,163,184,0.5);
        }
        .btn-outline:hover{
            background:rgba(15,23,42,0.8);
        }

        .hint{
            text-align:center;
            font-size:11px;
            color:#9ca3af;
            margin-top:4px;
        }

        /* ======= Scanner Modals / Layout (Ù…Ù† ÙƒÙˆØ¯Ùƒ Ù…Ø¹ Ø¨Ø¹Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨) ======= */
        .scanner-modal{
            position:fixed;
            inset:0;
            background:rgba(15,23,42,0.9);
            backdrop-filter:blur(6px);
            display:flex;
            align-items:center;
            justify-content:center;
            opacity:0;
            visibility:hidden;
            transition:.25s;
            z-index:9999;
        }
        .scanner-modal.active{
            opacity:1;
            visibility:visible;
        }
        .scanner-modal-content{
            width:100%;
            max-width:480px;
            background:radial-gradient(circle at top,#111827 0%,#020617 55%,#000 100%);
            border-radius:18px;
            padding:16px 16px 18px;
            border:1px solid rgba(148,163,184,0.4);
            box-shadow:0 22px 60px rgba(0,0,0,0.8);
            position:relative;
            color:#e5e7eb;
        }
        .scanner-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            margin-bottom:10px;
        }
        .scanner-header h2{
            font-size:16px;
        }
        .scanner-close-btn{
            border:none;
            background:transparent;
            color:#9ca3af;
            font-size:22px;
            cursor:pointer;
            line-height:1;
        }
        .scanner-close-btn:hover{
            color:#e5e7eb;
        }

        .scanner-preview{
            width:100%;
            aspect-ratio:3/2;
            border-radius:16px;
            overflow:hidden;
            background:#000;
            position:relative;
        }

        .scanner-preview::after{
            content:'';
            position:absolute;
            inset:16px;
            border-radius:14px;
            border:2px dashed rgba(248,250,252,0.4);
            box-shadow:0 0 0 999px rgba(0,0,0,0.3);
            pointer-events:none;
        }

        .scanner-hint{
            font-size:12px;
            color:#9ca3af;
            margin-top:8px;
            text-align:center;
        }

        .manual-search-section{
            margin-top:14px;
        }
        .manual-search-divider{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            color:#9ca3af;
            font-size:11px;
            margin-bottom:8px;
        }
        .manual-search-divider::before,
        .manual-search-divider::after{
            content:'';
            flex:1;
            height:1px;
            background:linear-gradient(to left,transparent,rgba(148,163,184,0.7));
        }
        .manual-search-divider::after{
            background:linear-gradient(to right,transparent,rgba(148,163,184,0.7));
        }

        .manual-search-input{
            display:flex;
            gap:8px;
        }

        .manual-search-input input{
            flex:1;
            padding:10px 12px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.4);
            background:rgba(15,23,42,0.9);
            color:#e5e7eb;
            font-size:13px;
        }
        .manual-search-input input:focus{
            outline:none;
            border-color:var(--primary-light);
            box-shadow:0 0 0 1px rgba(124,58,237,0.6);
        }

        .scanner-btn{
            border-radius:999px;
            border:none;
            padding:10px 16px;
            font-size:13px;
            cursor:pointer;
            font-weight:600;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
        }
        .scanner-btn.primary{
            background:linear-gradient(135deg,var(--primary),var(--primary-light));
            color:#fff;
        }
        .scanner-btn.secondary{
            background:rgba(15,23,42,0.9);
            border:1px solid rgba(148,163,184,0.5);
            color:#e5e7eb;
        }
        .scanner-btn.danger{
            background:linear-gradient(135deg,#b91c1c,#ef4444);
            color:#fff;
        }

        .scanner-actions{
            display:flex;
            gap:8px;
            margin-top:12px;
            flex-wrap:wrap;
        }

        /* Offer result modal */
        .offer-result{
            max-width:520px;
            background:radial-gradient(circle at top,#111827 0%,#020617 55%,#000 100%);
        }
        .offer-content{
            margin-top:10px;
            font-size:14px;
        }
        .offer-card{
            background:linear-gradient(145deg,rgba(15,23,42,0.95),rgba(15,23,42,0.6));
            border-radius:16px;
            padding:14px;
            border:1px solid rgba(148,163,184,0.3);
        }
        .search-results{
            max-height:320px;
            overflow-y:auto;
        }

        @media (max-width:480px){
            .scanner-modal-content{
                margin:12px;
                padding:14px;
            }
            .scanner-preview::after{
                inset:12px;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="logo">
            <img src="logo.png" alt="Rass 1 Hub" onerror="this.style.display='none'">
        </div>
        <div class="title">
            <h1>Rass 1 Hub - Scanner</h1>
            <p>Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Google Sheets</p>
        </div>

        <div class="card">
            <div class="main-actions">
                <button class="btn btn-primary" onclick="Scanner.start()">
                    ğŸ“· Ø§Ø¨Ø¯Ø£ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
                </button>
                <button class="btn btn-outline" onclick="Scanner.manualSearchFromHome()">
                    ğŸ” Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠ Ø¹Ù† Ø¹Ø±Ø¶
                </button>
            </div>
            <div class="hint">
                Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø³ØªÙ‚Ù„Ø© Ø¹Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ<br>
                ÙÙ‚Ø· Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ø³Ù… <strong>scanner.html</strong> ÙÙŠ Netlify.
            </div>
        </div>
    </div>

    <!-- Html5Qrcode Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
    /**
     * Barcode Scanner Module for Rass1 Hub
     * Adapted for plain HTML page (no modules)
     */

    // Offers data - loaded from Google Sheets
    let offersData = [];

    const Scanner = {
        scanner: null,
        isScanning: false,
        audioContext: null,
        isMobile: false,
        currentFacing: 'environment',
        searchResults: [],

        checkIsMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                || (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
        },

        async init() {
            // Create scanner modal if not exists
            if (!document.getElementById('scannerModal')) {
                this.createScannerModal();
            }
            // Load offers once
            if (!this._offersLoaded) {
                await this.loadOffersData();
                this._offersLoaded = true;
            }
        },

        createScannerModal() {
            const modalHTML = `
                <div id="scannerModal" class="scanner-modal">
                    <div class="scanner-modal-content">
                        <div class="scanner-header">
                            <h2 id="scannerModalTitle">ğŸ“· Scan Barcode</h2>
                            <button id="closeScannerBtn" class="scanner-close-btn">&times;</button>
                        </div>
                        
                        <!-- Camera Section (Mobile) -->
                        <div id="cameraSection">
                            <div id="scannerPreview" class="scanner-preview"></div>
                            <p class="scanner-hint">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</p>
                        </div>
                        
                        <!-- Manual Search Section -->
                        <div class="manual-search-section">
                            <div class="manual-search-divider" id="searchDivider">
                                <span>Ø£Ùˆ Ø§Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠØ§Ù‹</span>
                            </div>
                            <div class="manual-search-input">
                                <input type="text" id="manualSearchInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." />
                                <button id="manualSearchBtn" class="scanner-btn primary">ğŸ” Ø¨Ø­Ø«</button>
                            </div>
                        </div>
                        
                        <div class="scanner-actions" id="cameraActions">
                            <button id="switchCameraBtn" class="scanner-btn secondary">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                            <button id="stopScanBtn" class="scanner-btn danger">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­</button>
                        </div>
                    </div>
                </div>
                
                <div id="offerResultModal" class="scanner-modal">
                    <div class="scanner-modal-content offer-result">
                        <div class="scanner-header">
                            <h2 id="offerResultTitle">ğŸ‰ Offer Found!</h2>
                            <button id="closeOfferBtn" class="scanner-close-btn">&times;</button>
                        </div>
                        <div id="offerResultContent" class="offer-content"></div>
                        <div class="scanner-actions">
                            <button id="scanAgainBtn" class="scanner-btn primary">ğŸ” Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯</button>
                            <button id="closeOfferResultBtn" class="scanner-btn secondary">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            this.bindEvents();
        },

        bindEvents() {
            document.getElementById('closeScannerBtn')?.addEventListener('click', () => this.stop());
            document.getElementById('stopScanBtn')?.addEventListener('click', () => this.stop());
            document.getElementById('closeOfferBtn')?.addEventListener('click', () => this.closeOfferResult());
            document.getElementById('closeOfferResultBtn')?.addEventListener('click', () => this.closeOfferResult());
            document.getElementById('scanAgainBtn')?.addEventListener('click', () => {
                this.closeOfferResult();
                this.start();
            });
            document.getElementById('switchCameraBtn')?.addEventListener('click', () => this.switchCamera());

            const manualInput = document.getElementById('manualSearchInput');
            const manualBtn = document.getElementById('manualSearchBtn');

            if (manualInput) {
                manualInput.addEventListener('focus', () => {
                    if (this.isScanning && this.scanner) {
                        try { this.scanner.pause(true); } catch (e) {}
                    }
                });

                manualInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        manualInput.blur();
                        this.manualSearch();
                    }
                });
            }

            if (manualBtn) {
                manualBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    manualInput?.blur();
                    this.manualSearch();
                });
            }

            document.getElementById('scannerModal')?.addEventListener('click', (e) => {
                if (e.target.id === 'scannerModal') this.stop();
            });
        },

        async loadOffersData() {
            try {
                const sheetId = '1-_6mN6DpmuUbpgy3q3h-RXRjPepfhhcdIx2K3oybCzw';
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=0`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const jsonStr = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/)?.[1];
                if (jsonStr) {
                    const data = JSON.parse(jsonStr);
                    offersData = this.parseGoogleSheetsData(data);
                    console.log(`âœ… Loaded ${offersData.length} offers`);
                } else {
                    throw new Error('Data format mismatch from Google Sheets');
                }
            } catch (error) {
                console.error('âŒ Google Sheets Load Error:', error);
                offersData = this.getSampleData();
                console.log('ğŸ’¡ Using fallback s

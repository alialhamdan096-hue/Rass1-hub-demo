<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ù…Ø§Ø³Ø­ Ø§Ù„Ø¹Ø±ÙˆØ¶ | Rass1</title>
    <!-- html5-qrcode - ÙŠØ¯Ø¹Ù… iOS Ùˆ Android -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            min-height: 100vh;
            color: #fff;
        }
        .header {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            text-align: center;
        }
        .header h1 {
            font-size: 1.3rem;
        }
        .container {
            padding: 15px;
            max-width: 500px;
            margin: 0 auto;
        }
        .card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 15px;
        }
        .card h2 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        /* Scanner container */
        #reader {
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
        }
        #reader video {
            border-radius: 15px;
        }
        .hint {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            margin: 10px 0;
            font-size: 0.9rem;
        }
        .status {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: 600;
        }
        .status.ready {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        .status.error {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6b6b;
        }
        .status.loading {
            background: rgba(255, 200, 0, 0.2);
            color: #ffc800;
        }
        .divider {
            display: flex;
            align-items: center;
            margin: 15px 0;
            color: rgba(255, 255, 255, 0.5);
        }
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .divider span {
            padding: 0 15px;
        }
        .search-box {
            display: flex;
            gap: 10px;
        }
        .search-box input {
            flex: 1;
            padding: 14px;
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 1rem;
            -webkit-appearance: none;
        }
        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            -webkit-appearance: none;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            -webkit-appearance: none;
        }
        .offer-status {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .pricing {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .price-row:last-child {
            border: none;
        }
        .old-price {
            text-decoration: line-through;
            color: rgba(255, 255, 255, 0.5);
        }
        .new-price {
            color: #00ff88;
            font-weight: 700;
        }
        .no-offer {
            text-align: center;
            padding: 30px;
        }
        .no-offer .icon {
            font-size: 3rem;
        }
        .barcode-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            text-align: center;
            word-break: break-all;
        }
        .footer {
            text-align: center;
            padding: 15px;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.8rem;
        }
        /* Fix for html5-qrcode styles */
        #reader__scan_region {
            min-height: 200px !important;
        }
        #reader__dashboard_section_swaplink {
            color: #667eea !important;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>ğŸ›’ Ù…Ø§Ø³Ø­ Ø§Ù„Ø¹Ø±ÙˆØ¶ | Rass1</h1>
    </header>
    <main class="container">
        <div class="card">
            <h2 id="title">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h2>
            <div id="cameraArea">
                <div id="reader"></div>
                <p class="hint">Ø¶Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±</p>
            </div>
            <div class="status loading" id="status">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div>
            <div class="divider"><span>Ø£Ùˆ Ø§Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠØ§Ù‹</span></div>
            <div class="search-box">
                <input type="text" id="input" placeholder="Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" autocomplete="off">
                <button class="btn" id="searchBtn">ğŸ”</button>
            </div>
        </div>
    </main>
    <footer class="footer">Â© 2025 Rass1 Hub</footer>
    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ğŸ‰ Ø¹Ø±Ø¶!</h2>
                <button class="close-btn" id="closeBtn">&times;</button>
            </div>
            <div id="modalBody"></div>
            <button class="btn" style="width:100%; margin-top:15px" id="againBtn">ğŸ” Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>
    <script>
        // ===== GLOBALS =====
        let offers = [];
        let html5QrcodeScanner = null;
        let audioCtx = null;
        const status = document.getElementById('status');
        const input = document.getElementById('input');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const cameraArea = document.getElementById('cameraArea');
        const title = document.getElementById('title');
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        // ===== INIT =====
        async function init() {
            status.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
            await loadOffers();
            if (isMobile) {
                startScanner();
            } else {
                cameraArea.style.display = 'none';
                title.textContent = 'ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶';
                status.textContent = 'âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø­Ø«';
                status.className = 'status ready';
                input.focus();
            }
        }
        // ===== LOAD DATA =====
        async function loadOffers() {
            try {
                const id = '1-_6mN6DpmuUbpgy3q3h-RXRjPepfhhcdIx2K3oybCzw';
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json`);
                const txt = await res.text();
                const json = txt.match(/setResponse\(([\s\S]*)\);?/)?.[1];
                if (json) {
                    const data = JSON.parse(json);
                    offers = data.table.rows.slice(1).map(r => {
                        const c = r.c;
                        const getDate = (cell) => {
                            if (!cell) return '';
                            if (cell.f) return cell.f;
                            if (cell.v) {
                                const m = String(cell.v).match(/Date\((\d+),(\d+),(\d+)\)/);
                                if (m) return `${parseInt(m[2]) + 1}/${m[3]}/${m[1]}`;
                                return cell.v;
                            }
                            return '';
                        };
                        return {
                            barcode: c[0]?.v?.toString() || '',
                            name: c[1]?.v || '',
                            brand: c[2]?.v || '',
                            discount: c[3]?.f || c[3]?.v || '',
                            priceBefore: c[4]?.f || c[4]?.v || '',
                            save: c[5]?.f || c[5]?.v || '',
                            priceAfter: c[6]?.f || c[6]?.v || '',
                            startDate: getDate(c[8]),
                            endDate: getDate(c[9]),
                            arName: c[10]?.v || '',
                            category: c[12]?.v || ''
                        };
                    }).filter(o => o.barcode);
                    console.log('âœ… Loaded', offers.length, 'offers');
                }
            } catch (e) {
                console.error('Load error:', e);
            }
        }
        // ===== SCANNER - html5-qrcode library =====
        function startScanner() {
            status.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
            status.className = 'status loading';
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader",
                {
                    fps: 10,
                    qrbox: { width: 250, height: 150 },
                    rememberLastUsedCamera: true,
                    // Support all major barcode formats
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E,
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.CODE_39,
                        Html5QrcodeSupportedFormats.ITF,
                        Html5QrcodeSupportedFormats.QR_CODE
                    ]
                },
                /* verbose= */ false
            );
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            // Update status after camera starts
            setTimeout(() => {
                const videoElem = document.querySelector('#reader video');
                if (videoElem) {
                    status.textContent = 'ğŸ” Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø­ - ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯';
                    status.className = 'status ready';
                }
            }, 2000);
        }
        function onScanSuccess(decodedText, decodedResult) {
            console.log('ğŸ“· Scanned:', decodedText);
            beep();
            // Stop scanner temporarily
            html5QrcodeScanner.pause(true);
            const offer = offers.find(o => o.barcode === decodedText);
            showResult(decodedText, offer);
        }
        function onScanFailure(error) {
            // Ignore - this fires continuously when no barcode is detected
        }
        function resumeScanner() {
            if (html5QrcodeScanner) {
                try {
                    html5QrcodeScanner.resume();
                } catch (e) {
                    // If resume fails, restart
                    html5QrcodeScanner.clear();
                    startScanner();
                }
            }
        }
        // ===== BEEP =====
        function beep() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.value = 1800;
                osc.type = 'square';
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } catch (e) { }
        }
        // ===== DATE HELPERS =====
        function parseDate(s) {
            if (!s || s === 'âˆ') return null;
            let d = new Date(s);
            if (isNaN(d)) {
                const p = s.split('/');
                if (p.length === 3) d = new Date(p[2], p[0] - 1, p[1]);
            }
            return isNaN(d) ? null : d;
        }
        function getStatus(offer) {
            const now = new Date(); now.setHours(0, 0, 0, 0);
            const start = parseDate(offer.startDate);
            const end = parseDate(offer.endDate);
            if (start && start > now) {
                const d = Math.ceil((start - now) / 86400000);
                return { label: 'ğŸ”œ Ù„Ù… ÙŠØ¨Ø¯Ø£', msg: `ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ ${d} ÙŠÙˆÙ…`, color: '#95a5a6' };
            }
            if (end && end < now) {
                return { label: 'âŒ Ù…Ù†ØªÙ‡ÙŠ', msg: 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¹Ø±Ø¶', color: '#e74c3c' };
            }
            if (end) {
                const d = Math.ceil((end - now) / 86400000);
                if (d <= 3) return { label: 'âš ï¸ Ù‚Ø±ÙŠØ¨Ø§Ù‹', msg: `Ø¨Ø§Ù‚ÙŠ ${d} ÙŠÙˆÙ…`, color: '#f39c12' };
                return { label: 'âœ… Ø³Ø§Ø±ÙŠ', msg: `Ù…ØªØ¨Ù‚ÙŠ ${d} ÙŠÙˆÙ…`, color: '#27ae60' };
            }
            return { label: 'âœ… Ø³Ø§Ø±ÙŠ', msg: 'Ø¹Ø±Ø¶ Ù…Ø³ØªÙ…Ø±', color: '#27ae60' };
        }
        // ===== SHOW RESULT =====
        function showResult(code, offer) {
            if (offer) {
                const st = getStatus(offer);
                modalTitle.textContent = 'ğŸ‰ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø±Ø¶!';
                modalTitle.style.color = '#27ae60';
                modalBody.innerHTML = `
                    <div class="offer-status" style="background:${st.color}">
                        <span>${st.label}</span>
                        <span>${st.msg}</span>
                    </div>
                    <div style="margin-bottom:15px">
                        <div style="color:#667eea;font-size:0.8rem">${offer.brand}</div>
                        <h3>${offer.name}</h3>
                        <p style="color:rgba(255,255,255,0.7)">${offer.arName}</p>
                    </div>
                    <div class="pricing">
                        <div class="price-row">
                            <span>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ:</span>
                            <span class="old-price">${offer.priceBefore} Ø±ÙŠØ§Ù„</span>
                        </div>
                        <div class="price-row">
                            <span>Ø§Ù„Ø®ØµÙ…:</span>
                            <span style="background:#e74c3c;padding:4px 12px;border-radius:20px">${offer.discount}</span>
                        </div>
                        ${offer.save ? `<div class="price-row"><span>ØªÙˆÙÙŠØ±:</span><span class="new-price">${offer.save} Ø±ÙŠØ§Ù„</span></div>` : ''}
                        <div class="price-row" style="font-size:1.2rem;font-weight:700">
                            <span>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                            <span class="new-price">${offer.priceAfter} Ø±ÙŠØ§Ù„</span>
                        </div>
                    </div>
                `;
            } else {
                modalTitle.textContent = 'âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø±Ø¶';
                modalTitle.style.color = '#e74c3c';
                modalBody.innerHTML = `
                    <div class="no-offer">
                        <div class="icon">ğŸ“¦</div>
                        <div class="barcode-box">${code}</div>
                        <p>Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù„ÙŠØ³ Ù„Ù‡ Ø¹Ø±Ø¶ Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    </div>
                `;
            }
            modal.classList.add('show');
        }
        // ===== SEARCH =====
        function search() {
            const q = input.value.trim();
            if (!q) return;
            // By barcode
            const byCode = offers.find(o => o.barcode === q);
            if (byCode) {
                beep();
                showResult(q, byCode);
                input.value = '';
                return;
            }
            // By name
            const ql = q.toLowerCase();
            const results = offers.filter(o =>
                o.name?.toLowerCase().includes(ql) ||
                o.arName?.toLowerCase().includes(ql) ||
                o.brand?.toLowerCase().includes(ql)
            );
            if (results.length === 1) {
                beep();
                showResult(results[0].barcode, results[0]);
            } else if (results.length > 1) {
                modalTitle.textContent = `ğŸ” ${results.length} Ù†ØªÙŠØ¬Ø©`;
                modalTitle.style.color = '#3498db';
                let html = '<div style="max-height:300px;overflow:auto;-webkit-overflow-scrolling:touch">';
                results.forEach((o, i) => {
                    html += `<div onclick="pick(${i})" style="background:rgba(255,255,255,0.08);border-radius:12px;padding:15px;margin-bottom:10px;cursor:pointer">
                        <div style="color:#667eea;font-size:0.75rem">${o.brand}</div>
                        <div>${o.name}</div>
                        <div><span class="old-price">${o.priceBefore}</span> <span class="new-price">${o.priceAfter} Ø±ÙŠØ§Ù„</span></div>
                    </div>`;
                });
                html += '</div>';
                modalBody.innerHTML = html;
                modal.classList.add('show');
                window._results = results;
            } else {
                showResult(q, null);
            }
            input.value = '';
        }
        window.pick = function (i) {
            const o = window._results[i];
            showResult(o.barcode, o);
        };
        // ===== CLOSE MODAL =====
        function closeModal() {
            modal.classList.remove('show');
            if (isMobile) {
                resumeScanner();
            }
            input.focus();
        }
        // ===== EVENTS =====
        document.getElementById('searchBtn').onclick = search;
        input.onkeypress = e => { if (e.key === 'Enter') search(); };
        document.getElementById('closeBtn').onclick = closeModal;
        document.getElementById('againBtn').onclick = closeModal;
        // ===== START =====
        init();
    </script>
</body>
</html>
